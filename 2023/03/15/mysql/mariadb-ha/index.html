<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content=#222><meta name=generator content="Hexo 6.0.0"><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32-next.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16-next.png><link rel=mask-icon href=/images/logo.svg color=#222><link rel=stylesheet href=/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CLobster+Two:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><script class=next-config data-name=main type=application/json>{"hostname":"tungsing.cc","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta name=description content="前言 在做基础脚手架开发的过程中涉及到代码要不要支持读写分离，支持的话的需要一定的工作量，虽然代码不多，也比较容易实现，但毕竟需要维护。为了避免重新写轮子，先查询。还有真有不少解决方案，第一种就是基于应用的，自己在应用程序中编码实现；第二种就是基于中间件，有MySQL Proxy、MaxScale和HAProxy等，MySQL Proxy已经不维护了；HAProxy本身不支持读写分离，还需要搭配其"><meta property=og:type content=article><meta property=og:title content=搭建MariaDB读写分离、高可用><meta property=og:url content=http://tungsing.cc/2023/03/15/mysql/mariadb-ha/index.html><meta property=og:site_name content="TungSing&#39;s Blog"><meta property=og:description content="前言 在做基础脚手架开发的过程中涉及到代码要不要支持读写分离，支持的话的需要一定的工作量，虽然代码不多，也比较容易实现，但毕竟需要维护。为了避免重新写轮子，先查询。还有真有不少解决方案，第一种就是基于应用的，自己在应用程序中编码实现；第二种就是基于中间件，有MySQL Proxy、MaxScale和HAProxy等，MySQL Proxy已经不维护了；HAProxy本身不支持读写分离，还需要搭配其"><meta property=og:locale content=zh_CN><meta property=og:image content=http://tungsing.cc/images/book/design_pattern.jpg><meta property=og:image content=http://tungsing.cc/images/mysql/mariadb_ha.png><meta property=article:published_time content=2023-03-15T01:39:57.236Z><meta property=article:modified_time content=2023-03-20T09:57:05.508Z><meta property=article:author content=TungSing><meta property=article:tag content=HA><meta property=article:tag content="High Availability"><meta property=article:tag content=MariaDB><meta name=twitter:card content=summary><meta name=twitter:image content=http://tungsing.cc/images/book/design_pattern.jpg><link rel=canonical href=http://tungsing.cc/2023/03/15/mysql/mariadb-ha/ ><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://tungsing.cc/2023/03/15/mysql/mariadb-ha/","path":"2023/03/15/mysql/mariadb-ha/","title":"搭建MariaDB读写分离、高可用"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>搭建MariaDB读写分离、高可用 | TungSing's Blog</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript><link rel=alternate href=/atom.xml title="TungSing's Blog" type=application/atom+xml></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><p class=site-title>TungSing's Blog</p><i class=logo-line></i></a><p class=site-subtitle itemprop=description>用心记录一切！</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>71</span></a></li><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>10</span></a></li><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>57</span></a></li><li class="menu-item menu-item-photos"><a href=/photos/ rel=section><i class="fa fa-image fa-fw"></i>相册</a></li><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role=button class=popup-trigger><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%89%8D%E8%A8%80><span class=nav-number>1.</span> <span class=nav-text>前言</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%8E%AF%E5%A2%83><span class=nav-number>2.</span> <span class=nav-text>环境</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92><span class=nav-number>3.</span> <span class=nav-text>环境规划</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#MariaDB-%E4%B8%BB%E4%BB%8E%E6%90%AD%E5%BB%BA><span class=nav-number>4.</span> <span class=nav-text>MariaDB 主从搭建</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#Master-%E5%AE%89%E8%A3%85><span class=nav-number>4.1.</span> <span class=nav-text>Master 安装</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#Slave-%E5%AE%89%E8%A3%85><span class=nav-number>4.2.</span> <span class=nav-text>Slave 安装</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%90%AD%E5%BB%BA%E9%85%8D%E7%BD%AE><span class=nav-number>4.3.</span> <span class=nav-text>搭建配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#MaxScale-%E6%90%AD%E5%BB%BA><span class=nav-number>5.</span> <span class=nav-text>MaxScale 搭建</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#Master-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE><span class=nav-number>5.1.</span> <span class=nav-text>Master 安装配置</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#Slave-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE><span class=nav-number>5.2.</span> <span class=nav-text>Slave 安装配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#Keepalived-%E6%90%AD%E5%BB%BA><span class=nav-number>6.</span> <span class=nav-text>Keepalived 搭建</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#Master-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-1><span class=nav-number>6.1.</span> <span class=nav-text>Master 安装配置</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#Backup-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE><span class=nav-number>6.2.</span> <span class=nav-text>Backup 安装配置</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%B5%8B%E8%AF%95><span class=nav-number>6.3.</span> <span class=nav-text>测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%BB%93%E8%AF%AD><span class=nav-number>7.</span> <span class=nav-text>结语</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99><span class=nav-number>8.</span> <span class=nav-text>参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><p class=site-author-name itemprop=name>TungSing</p><div class=site-description itemprop=description>多读书多看报</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/ ><span class=site-state-item-count>57</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/ ><span class=site-state-item-count>10</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/ ><span class=site-state-item-count>71</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class=links-of-author-item><a href=https://github.com/tungsing title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tungsing" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class=links-of-author-item><a href=mailto:dsh.gao@gmail.com title="E-Mail → mailto:dsh.gao@gmail.com" rel=noopener target=_blank><i class="fa fa-envelope fa-fw"></i>E-Mail</a> </span><span class=links-of-author-item><a href=https://twitter.com/dongsheng__gao title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;dongsheng__gao" rel=noopener target=_blank><i class="fab fa-twitter fa-fw"></i>Twitter</a> </span><span class=links-of-author-item><a href=https://t.me/tungsing_gao title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;tungsing_gao" rel=noopener target=_blank><i class="fab fa-telegram fa-fw"></i>Telegram</a></span></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=back-to-top role=button aria-label=返回顶部><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang=zh-CN><link itemprop=mainEntityOfPage href=http://tungsing.cc/2023/03/15/mysql/mariadb-ha/ ><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/avatar.gif><meta itemprop=name content=TungSing><meta itemprop=description content=多读书多看报></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="TungSing's Blog"></span><header class=post-header><h1 class=post-title itemprop="name headline">搭建MariaDB读写分离、高可用</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i> </span><span class=post-meta-item-text>发表于</span> <time title="创建时间：2023-03-15 01:39:57" itemprop="dateCreated datePublished" datetime=2023-03-15T01:39:57Z>2023-03-15</time> </span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i> </span><span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-03-20 09:57:05" itemprop=dateModified datetime=2023-03-20T09:57:05Z>2023-03-20</time> </span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i> </span><span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/database/ itemprop=url rel=index><span itemprop=name>database</span></a></span></span></div></div></header><div class=post-body itemprop=articleBody><h4 id=前言><a href=#前言 class=headerlink title=前言></a>前言</h4><blockquote><p>在做基础脚手架开发的过程中涉及到代码要不要支持读写分离，支持的话的需要一定的工作量，虽然代码不多，也比较容易实现，但毕竟需要维护。为了避免重新写轮子，先查询。还有真有不少解决方案，第一种就是基于应用的，自己在应用程序中编码实现；第二种就是基于中间件，有MySQL Proxy、MaxScale和HAProxy等，MySQL Proxy已经不维护了；HAProxy本身不支持读写分离，还需要搭配其他才能实现；MaxScale 文档比较全，并且是MariaDB 开发的，所以先用起来看看效果。</p></blockquote><p><img src=/images/book/design_pattern.jpg></p><span id=more></span><h4 id=环境><a href=#环境 class=headerlink title=环境></a>环境</h4><ul><li>Linux rocky 8</li><li>MariaDB 10.3</li><li>MariaDB MaxScale 6.4</li><li>Keepalived 2.1.5</li></ul><h4 id=环境规划><a href=#环境规划 class=headerlink title=环境规划></a>环境规划</h4><p><img src=/images/mysql/mariadb_ha.png></p><table><thead><tr><th align=center>序号</th><th>应用</th><th>hostname</th><th>IP</th><th>端口</th></tr></thead><tbody><tr><td align=center>1</td><td>MariaDB Master</td><td>mariadb_master</td><td>192.168.56.116</td><td>3306</td></tr><tr><td align=center>2</td><td>MariaDB Slave</td><td>mariadb_slave</td><td>192.168.56.117</td><td>3306</td></tr><tr><td align=center>3</td><td>MaxScale Master 和 Keepalived Master</td><td>msk_master</td><td>192.168.56.118</td><td>4006/8989</td></tr><tr><td align=center>4</td><td>MaxScale Backup 和 Keepalived Backup</td><td>msk_backup</td><td>192.168.56.119</td><td>4006/8989</td></tr><tr><td align=center>5</td><td>VIP</td><td></td><td>192.168.56.120</td><td></td></tr></tbody></table><h4 id=MariaDB-主从搭建><a href=#MariaDB-主从搭建 class=headerlink title="MariaDB 主从搭建"></a>MariaDB 主从搭建</h4><h5 id=Master-安装><a href=#Master-安装 class=headerlink title="Master 安装"></a>Master 安装</h5><ol><li><p>检查是否之前是否有安装，有删除</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>yum list installed | grep -i maria</span><br><span class=line>yum list installed | grep -i mysql</span><br></pre></td></tr></table></figure></li><li><p>安装</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum install mariadb-server</span><br></pre></td></tr></table></figure></li><li><p>修改默认数据目录，</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 创建目录</span></span><br><span class=line>mkdir /home/mariadb_data</span><br><span class=line><span class=comment># 2. 拷贝目录数据目录</span></span><br><span class=line>cp -a /var/lib/mysql /home/mariadb_data/</span><br><span class=line><span class=comment># 3. 修改mariadb server 配置文件</span></span><br><span class=line>vi /etc/my.cnf.d/mariadb-server.cnf</span><br><span class=line><span class=comment># 需要修改的内容</span></span><br><span class=line>datadir=/home/mariadb_data/mysql</span><br><span class=line>socket=/home/mariadb_data/mysql/mysql.sock</span><br><span class=line><span class=comment># 4. 修改客户端配置文件</span></span><br><span class=line>vi /etc/my.cnf.d/client.cnf</span><br><span class=line><span class=comment># 需要修改的内容</span></span><br><span class=line>[client]</span><br><span class=line>socket=/home/mariadb_data/mysql/mysql.sock</span><br></pre></td></tr></table></figure></li><li><p>修改SELinux对MySQL默认数据目录的保护</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 打开/etc/selinux/targeted/contexts/files/file_contexts.local</span></span><br><span class=line>vi /etc/selinux/targeted/contexts/files/file_contexts.local</span><br><span class=line><span class=comment># 2. 添加以下内容</span></span><br><span class=line>/home/mariadb_data(/.*)?   system_u:object_r:mysqld_db_t:s0</span><br><span class=line><span class=comment># 如果已执行过启动执行命令请重新授权</span></span><br><span class=line>chcon -R -t mysqld_db_t /home/mariadb_data/</span><br></pre></td></tr></table></figure></li><li><p>启动MySQL</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 启动</span></span><br><span class=line>systemctl start mariadb</span><br><span class=line><span class=comment># 开启自启动</span></span><br><span class=line>systemctl <span class=built_in>enable</span> mariadb</span><br></pre></td></tr></table></figure></li><li><p>数据库初始化</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 临时设置MYSQL_UNIX_PORT变量</span></span><br><span class=line><span class=built_in>export</span> MYSQL_UNIX_PORT=/home/mariadb_data/mysql/mysql.sock</span><br><span class=line><span class=comment># 2. 执行命令</span></span><br><span class=line>mysql_secure_installation</span><br><span class=line><span class=comment># 说明</span></span><br><span class=line><span class=comment># 首先是设置密码，会提示先输入密码:</span></span><br><span class=line>Enter current password <span class=keyword>for</span> root (enter <span class=keyword>for</span> none):&lt;–初次运行直接回车</span><br><span class=line><span class=comment># 设置密码</span></span><br><span class=line>Set root password? [Y/n] &lt;– 是否设置root用户密码，输入y并回车或直接回车</span><br><span class=line>New password: &lt;– 设置root用户的密码</span><br><span class=line>Re-enter new password: &lt;– 再输入一次你设置的密码</span><br><span class=line><span class=comment># 其它配置</span></span><br><span class=line>Remove anonymous users? [Y/n] &lt;– 是否删除匿名用户，回车</span><br><span class=line>Disallow root login remotely? [Y/n] &lt;–是否禁止root远程登录,回车,</span><br><span class=line>Remove <span class=built_in>test</span> database and access to it? [Y/n] &lt;– 是否删除<span class=built_in>test</span>数据库，回车</span><br><span class=line>Reload privilege tables now? [Y/n] &lt;– 是否重新加载权限表，回车</span><br></pre></td></tr></table></figure></li><li><p>测试登陆</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 登陆到MySQL Server</span></span><br><span class=line>mysql -uroot -p</span><br></pre></td></tr></table></figure></li></ol><h5 id=Slave-安装><a href=#Slave-安装 class=headerlink title="Slave 安装"></a>Slave 安装</h5><p>同master</p><h5 id=搭建配置><a href=#搭建配置 class=headerlink title=搭建配置></a>搭建配置</h5><ol><li><p>修改master的<code>my.cnf</code>配置文件</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre></td><td class=code><pre><span class=line><span class=comment># server id 唯一</span></span><br><span class=line>server_id=116</span><br><span class=line><span class=comment># GTID 模式</span></span><br><span class=line>gtid_strict_mode=1</span><br><span class=line><span class=comment># 是否记录从服务器同步数据动作</span></span><br><span class=line>log-slave-updates=ON</span><br><span class=line><span class=comment># 开启及设置二进制日志文件名称</span></span><br><span class=line>log_bin=mysql-bin</span><br><span class=line><span class=comment># 设置binlog文件格式</span></span><br><span class=line>binlog_format=MIXED</span><br><span class=line></span><br><span class=line><span class=comment># 记录IO线程读取已经读取到的master binlog位置，用于slave宕机后IO线程根据文件中的POS点重新拉取binlog日志</span></span><br><span class=line>master-info-repository = TABLE</span><br><span class=line><span class=comment># 记录SQL线程读取Master binlog的位置，用于Slave 宕机后根据文件中记录的pos点恢复Sql线程</span></span><br><span class=line>relay-log-info-repository = TABLE   </span><br><span class=line><span class=comment># 启用确保无信息丢失；任何一个事务提交后, 将二进制日志的文件名及事件位置记录到文件中</span></span><br><span class=line>sync-master-info = 1</span><br><span class=line><span class=comment># 设定从服务器的复制线程数；0表示关闭多线程复制功能</span></span><br><span class=line>slave-parallel-workers = 2</span><br><span class=line><span class=comment># 设置binlog校验算法（循环冗余校验码）</span></span><br><span class=line>binlog-checksum = CRC32</span><br><span class=line><span class=comment># 设置主服务器是否校验</span></span><br><span class=line>master-verify-checksum = 1</span><br><span class=line><span class=comment># 设置从服务器是否校验</span></span><br><span class=line>slave-sql-verify-checksum = 1</span><br><span class=line><span class=comment># 用于在二进制日志记录事件相关的信息，可降低故障排除的复杂度</span></span><br><span class=line>binlog-rows-query-log_events = 1</span><br><span class=line><span class=comment># 保证master crash safe，该参数必须设置为1</span></span><br><span class=line>sync_binlog = 1</span><br><span class=line><span class=comment># 保证master crash safe，该参数必须设置为1</span></span><br><span class=line>innodb_flush_log_at_trx_commit = 1   </span><br></pre></td></tr></table></figure></li><li><p>重启MariaDB Server</p></li><li><p>添加同步用户</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>GRANT REPLICATION SLAVE,RELOAD,SUPER ON *.* TO replication@<span class=string>&#x27;192.168.56.%&#x27;</span> IDENTIFIED BY <span class=string>&#x27;1234@abCD&#x27;</span>;</span><br><span class=line>FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></li><li><p>查看master 状态并记录下位置信息</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br></pre></td><td class=code><pre><span class=line>SELECT @@GLOBAL.gtid_current_pos;</span><br><span class=line>+---------------------------+</span><br><span class=line>| @@GLOBAL.gtid_current_pos |</span><br><span class=line>+---------------------------+</span><br><span class=line>| 0-116-12                  |</span><br><span class=line>+---------------------------+</span><br></pre></td></tr></table></figure></li><li><p>修改slave的<code>my.cnf</code> 配置文件</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br></pre></td><td class=code><pre><span class=line><span class=comment># server id 唯一</span></span><br><span class=line>server-id=117</span><br><span class=line><span class=comment># GTID 模式</span></span><br><span class=line>gtid_strict_mode=1</span><br><span class=line><span class=comment># 是否记录从服务器同步数据动作</span></span><br><span class=line>log-slave-updates=ON</span><br><span class=line><span class=comment># 开启及设置二进制日志文件名称</span></span><br><span class=line>log_bin=mysql-bin</span><br><span class=line><span class=comment># 设置binlog文件格式</span></span><br><span class=line>binlog_format=MIXED</span><br><span class=line><span class=comment># 设置一般用户为只读模式</span></span><br><span class=line>read-only=1</span><br><span class=line></span><br><span class=line>master-info-repository = TABLE</span><br><span class=line>relay-log-info-repository = TABLE</span><br><span class=line>sync-master-info = 1</span><br><span class=line>slave-parallel-workers = 4</span><br><span class=line>binlog-checksum = CRC32</span><br><span class=line>master-verify-checksum = 1</span><br><span class=line>slave-sql-verify-checksum = 1</span><br><span class=line>binlog-rows-query-log_events = 1</span><br><span class=line><span class=comment># crash safe slave</span></span><br><span class=line>relay_log_recovery = 1</span><br></pre></td></tr></table></figure></li><li><p>重启MariaDB Server</p></li><li><p>打开master 防火墙的3306 端口</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class=line>firewall-cmd --reload</span><br></pre></td></tr></table></figure></li><li><p>配置从主库同步数据</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 登陆MySQL slave Server</span></span><br><span class=line>mysql -uroot -p</span><br><span class=line><span class=built_in>set</span> global gtid_slave_pos = <span class=string>&quot;0-116-12&quot;</span>;</span><br><span class=line><span class=comment># 2. 配置</span></span><br><span class=line><span class=comment># MASTER_LOG_FILE 和 MASTER_LOG_POS 的值就是从 主库 show master status 命令中获取的信息</span></span><br><span class=line>mysql&gt; CHANGE MASTER TO MASTER_HOST=<span class=string>&#x27;192.168.56.116&#x27;</span>,</span><br><span class=line>       MASTER_USER=<span class=string>&#x27;replication&#x27;</span>,</span><br><span class=line>       MASTER_PASSWORD=<span class=string>&#x27;1234@abCD&#x27;</span>,</span><br><span class=line>       master_use_gtid=slave_pos;</span><br><span class=line><span class=comment># 3. 开启同步</span></span><br><span class=line>mysql&gt; start slave;</span><br></pre></td></tr></table></figure></li><li><p>查看同步情况</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show slave status\G</span><br><span class=line><span class=comment># 检查以下参数都是 Yes 代表正常</span></span><br><span class=line>Slave_IO_Running: Yes</span><br><span class=line>Slave_SQL_Running: Yes</span><br><span class=line></span><br></pre></td></tr></table></figure></li><li><p>测试，通过创建数据库、表，添加数据来看同步是否正常</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 创建测试库和测试用户</span></span><br><span class=line>CREATE DATABASE ivy_base CHARACTER SET utf8mb4;</span><br><span class=line>grant all on ivy_base.* to <span class=string>&#x27;ivy_base&#x27;</span>@<span class=string>&#x27;%&#x27;</span> identified by <span class=string>&#x27;1234@abCD&#x27;</span>;</span><br><span class=line>flush privileges;</span><br><span class=line><span class=comment># 2. 执行创建表、添加数据、查询数据等操作</span></span><br><span class=line>CREATE TABLE `<span class=built_in>test</span>` (</span><br><span class=line>  `id` int(11) NOT NULL,</span><br><span class=line>  `name` varchar(200) DEFAULT NULL,</span><br><span class=line>  PRIMARY KEY (`id`)</span><br><span class=line>) ;</span><br><span class=line>INSERT INTO <span class=built_in>test</span> (id, NAME) VALUES (<span class=string>&#x27;2&#x27;</span>, <span class=string>&#x27;1&#x27;</span>);</span><br><span class=line>select * from <span class=built_in>test</span>;</span><br></pre></td></tr></table></figure></li></ol><h4 id=MaxScale-搭建><a href=#MaxScale-搭建 class=headerlink title="MaxScale 搭建"></a>MaxScale 搭建</h4><h5 id=Master-安装配置><a href=#Master-安装配置 class=headerlink title="Master 安装配置"></a>Master 安装配置</h5><ol><li><p>通过<a target=_blank rel=noopener href=https://mariadb.com/downloads/community/maxscale/ >官网</a>下载安装包</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>wget https://dlm.mariadb.com/2717592/MaxScale/6.4.5/yum/centos/8/x86_64/maxscale-6.4.5-1.rhel.8.x86_64.rpm</span><br></pre></td></tr></table></figure></li><li><p>安装</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum install maxscale-6.4.5-1.rhel.8.x86_64.rpm</span><br></pre></td></tr></table></figure></li><li><p>在MySQL Master 上添加监控和路由用户</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 连接MySQL Server</span></span><br><span class=line>mysql -uroot -p</span><br><span class=line><span class=comment># 2. 添加监控用户</span></span><br><span class=line>grant Replication slave,Replication client,Super,Reload  on *.* to <span class=string>&#x27;maxmon&#x27;</span>@<span class=string>&#x27;192.168.56.%&#x27;</span> identified by <span class=string>&#x27;1234@abCD&#x27;</span>;</span><br><span class=line><span class=comment># 3. 添加路由用户</span></span><br><span class=line>grant select on mysql.* to <span class=string>&#x27;maxrou&#x27;</span>@<span class=string>&#x27;192.168.56.%&#x27;</span> identified by <span class=string>&#x27;1234@abCD&#x27;</span>;</span><br><span class=line>grant show databases on *.* to <span class=string>&#x27;maxrou&#x27;</span>@<span class=string>&#x27;192.168.56.%&#x27;</span>;</span><br><span class=line><span class=comment># 4. 刷新权限信息</span></span><br><span class=line>flush privileges;</span><br></pre></td></tr></table></figure></li><li><p>读写分离配置，故障自动转移。具体可阅读<a target=_blank rel=noopener href=https://github.com/mariadb-corporation/MaxScale/blob/6.4.5/Documentation/Documentation-Contents.md>官方配置</a></p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 打开配置文件</span></span><br><span class=line>vim /etc/maxscale.cnf</span><br><span class=line><span class=comment># 2. 配置</span></span><br><span class=line><span class=comment># 基础配置</span></span><br><span class=line>[maxscale]</span><br><span class=line>threads=auto</span><br><span class=line>admin_host=0.0.0.0</span><br><span class=line>admin_secure_gui=<span class=literal>false</span></span><br><span class=line></span><br><span class=line><span class=comment># MySQL Server 配置</span></span><br><span class=line>[server1]</span><br><span class=line><span class=built_in>type</span>=server</span><br><span class=line>address=192.168.56.116</span><br><span class=line>port=3306</span><br><span class=line>protocol=MariaDBBackend</span><br><span class=line></span><br><span class=line>[server2]</span><br><span class=line><span class=built_in>type</span>=server</span><br><span class=line>address=192.168.56.117</span><br><span class=line>port=3306</span><br><span class=line>protocol=MariaDBBackend</span><br><span class=line><span class=comment># 监控配置</span></span><br><span class=line>[MariaDB-Monitor]</span><br><span class=line><span class=built_in>type</span>=monitor</span><br><span class=line>module=mariadbmon</span><br><span class=line>servers=server1,server2</span><br><span class=line>user=maxmon</span><br><span class=line>password=password</span><br><span class=line>monitor_interval=2000</span><br><span class=line><span class=comment># 用来执行CHANGE MASTER TO 命令的</span></span><br><span class=line>replication_user=replication</span><br><span class=line>replication_password=1234@abCD</span><br><span class=line><span class=comment># 打开自动故障转移</span></span><br><span class=line>auto_failover=<span class=literal>true</span></span><br><span class=line><span class=comment># 打开自动重新加入</span></span><br><span class=line>auto_rejoin=<span class=literal>true</span></span><br><span class=line><span class=comment># slave 全部失效时 master 支撑全部请求</span></span><br><span class=line>detect_stale_master=<span class=literal>true</span></span><br><span class=line>failover_timeout=5 </span><br><span class=line>failcount=5</span><br><span class=line>master_failure_timeout=2</span><br><span class=line>verify_master_failure=<span class=literal>true</span></span><br><span class=line>switchover_timeout=90</span><br><span class=line></span><br><span class=line></span><br><span class=line><span class=comment># 过滤器配置</span></span><br><span class=line><span class=comment># 非必须配置，是我使用的客户端工具默认会执行解释计划，但默认explain plan 会被路由到从库</span></span><br><span class=line>[Named-Server-Filter]</span><br><span class=line><span class=built_in>type</span>=filter</span><br><span class=line>module=namedserverfilter</span><br><span class=line>match01=^explain.*</span><br><span class=line>target01=server1</span><br><span class=line></span><br><span class=line><span class=comment># 读写分离服务配置</span></span><br><span class=line>[Read-Write-Service]</span><br><span class=line><span class=built_in>type</span>=service</span><br><span class=line>router=readwritesplit</span><br><span class=line>servers=server1,server2</span><br><span class=line>user=maxrou</span><br><span class=line>password=password</span><br><span class=line>filters=Named-Server-Filter</span><br><span class=line></span><br><span class=line><span class=comment># 读写分离监听配置</span></span><br><span class=line>[Read-Write-Listener]</span><br><span class=line><span class=built_in>type</span>=listener</span><br><span class=line>service=Read-Write-Service</span><br><span class=line>protocol=MySQLClient</span><br><span class=line>port=4006</span><br></pre></td></tr></table></figure></li><li><p>启动MaxScale</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 启动</span></span><br><span class=line>systemctl start maxscale</span><br><span class=line><span class=comment># 加入开机自启动</span></span><br><span class=line>systemctl <span class=built_in>enable</span> maxscale</span><br></pre></td></tr></table></figure></li><li><p>测试读写分离</p><p>用MySQL客户端或者命令连接上MaxScale，对数据库的表进行添加和查询数据，观察read/write值的变化</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 通过命令监控 read/write 的数量变化</span></span><br><span class=line>maxctrl show services</span><br><span class=line><span class=comment># 结果</span></span><br><span class=line>│ Router Diagnostics  │ &#123;                                                           │</span><br><span class=line>│                     │     <span class=string>&quot;avg_sescmd_history_length&quot;</span>: 0,                         │</span><br><span class=line>│                     │     <span class=string>&quot;max_sescmd_history_length&quot;</span>: 32,                        │</span><br><span class=line>│                     │     <span class=string>&quot;queries&quot;</span>: 117,                                         │</span><br><span class=line>│                     │     <span class=string>&quot;replayed_transactions&quot;</span>: 0,                             │</span><br><span class=line>│                     │     <span class=string>&quot;ro_transactions&quot;</span>: 0,                                   │</span><br><span class=line>│                     │     <span class=string>&quot;route_all&quot;</span>: 33,                                        │</span><br><span class=line>│                     │     <span class=string>&quot;route_master&quot;</span>: 9,                                      │</span><br><span class=line>│                     │     <span class=string>&quot;route_slave&quot;</span>: 75,                                      │</span><br><span class=line>│                     │     <span class=string>&quot;rw_transactions&quot;</span>: 0,                                   │</span><br><span class=line>│                     │     <span class=string>&quot;server_query_statistics&quot;</span>: [                            │</span><br><span class=line>│                     │         &#123;                                                   │</span><br><span class=line>│                     │             <span class=string>&quot;avg_selects_per_session&quot;</span>: 0,                   │</span><br><span class=line>│                     │             <span class=string>&quot;avg_sess_duration&quot;</span>: <span class=string>&quot;0ns&quot;</span>,                     │</span><br><span class=line>│                     │             <span class=string>&quot;id&quot;</span>: <span class=string>&quot;server1&quot;</span>,                                │</span><br><span class=line>│                     │             <span class=string>&quot;read&quot;</span>: 33,                                     │</span><br><span class=line>│                     │             <span class=string>&quot;total&quot;</span>: 42,                                    │</span><br><span class=line>│                     │             <span class=string>&quot;write&quot;</span>: 9                                      │</span><br><span class=line>│                     │         &#125;,                                                  │</span><br><span class=line>│                     │         &#123;                                                   │</span><br><span class=line>│                     │             <span class=string>&quot;avg_selects_per_session&quot;</span>: 0,                   │</span><br><span class=line>│                     │             <span class=string>&quot;avg_sess_duration&quot;</span>: <span class=string>&quot;0ns&quot;</span>,                     │</span><br><span class=line>│                     │             <span class=string>&quot;id&quot;</span>: <span class=string>&quot;server2&quot;</span>,                                │</span><br><span class=line>│                     │             <span class=string>&quot;read&quot;</span>: 108,                                    │</span><br><span class=line>│                     │             <span class=string>&quot;total&quot;</span>: 108,                                   │</span><br><span class=line>│                     │             <span class=string>&quot;write&quot;</span>: 0                                      │</span><br><span class=line>│                     │         &#125;                                                   │</span><br><span class=line>│                     │     ]                                                       │</span><br><span class=line>│                     │ &#125; </span><br><span class=line></span><br><span class=line><span class=comment># 2. 通过MaxGUI监控 http://127.0.0.1:8989</span></span><br></pre></td></tr></table></figure></li><li><p>测试故障转移</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 查看server 情况</span></span><br><span class=line>maxctrl list servers</span><br><span class=line>┌─────────┬────────────────┬──────┬─────────────┬──────────────────────────────┬──────────┐</span><br><span class=line>│ Server  │ Address        │ Port │ Connections │ State                        │ GTID     │</span><br><span class=line>├─────────┼────────────────┼──────┼─────────────┼──────────────────────────────┼──────────┤</span><br><span class=line>│ server1 │ 192.168.56.116 │ 3306 │ 0           │ Master, Running              │ 0-117-20 │</span><br><span class=line>├─────────┼────────────────┼──────┼─────────────┼──────────────────────────────┼──────────┤</span><br><span class=line>│ server2 │ 192.168.56.117 │ 3306 │ 0           │ Relay Master, Slave, Running │ 0-117-20 │</span><br><span class=line>└─────────┴────────────────┴──────┴─────────────┴──────────────────────────────┴──────────┘</span><br><span class=line></span><br><span class=line><span class=comment># 2. 登陆到master 服务器上停掉MariaDB</span></span><br><span class=line>systemctl stop MariaDB</span><br><span class=line><span class=comment># 3. 再次查看server情况</span></span><br><span class=line>maxctrl list servers</span><br><span class=line>┌─────────┬────────────────┬──────┬─────────────┬─────────────────┬──────────┐</span><br><span class=line>│ Server  │ Address        │ Port │ Connections │ State           │ GTID     │</span><br><span class=line>├─────────┼────────────────┼──────┼─────────────┼─────────────────┼──────────┤</span><br><span class=line>│ server1 │ 192.168.56.116 │ 3306 │ 0           │ Down            │ 0-117-20 │</span><br><span class=line>├─────────┼────────────────┼──────┼─────────────┼─────────────────┼──────────┤</span><br><span class=line>│ server2 │ 192.168.56.117 │ 3306 │ 0           │ Master, Running │ 0-117-20 │</span><br><span class=line>└─────────┴────────────────┴──────┴─────────────┴─────────────────┴──────────┘</span><br><span class=line><span class=comment># 4. 再次启动停掉的MariaDB</span></span><br><span class=line>systemctl start mariadb</span><br><span class=line><span class=comment># 5. 再次查看server情况，启动的节点已经重新加入</span></span><br><span class=line>maxctrl list servers</span><br><span class=line>┌─────────┬────────────────┬──────┬─────────────┬─────────────────┬──────────┐</span><br><span class=line>│ Server  │ Address        │ Port │ Connections │ State           │ GTID     │</span><br><span class=line>├─────────┼────────────────┼──────┼─────────────┼─────────────────┼──────────┤</span><br><span class=line>│ server1 │ 192.168.56.116 │ 3306 │ 0           │ Slave, Running  │ 0-117-20 │</span><br><span class=line>├─────────┼────────────────┼──────┼─────────────┼─────────────────┼──────────┤</span><br><span class=line>│ server2 │ 192.168.56.117 │ 3306 │ 0           │ Master, Running │ 0-117-20 │</span><br><span class=line>└─────────┴────────────────┴──────┴─────────────┴─────────────────┴──────────┘</span><br></pre></td></tr></table></figure></li></ol><h5 id=Slave-安装配置><a href=#Slave-安装配置 class=headerlink title="Slave 安装配置"></a>Slave 安装配置</h5><p>同master安装配置</p><h4 id=Keepalived-搭建><a href=#Keepalived-搭建 class=headerlink title="Keepalived 搭建"></a>Keepalived 搭建</h4><h5 id=Master-安装配置-1><a href=#Master-安装配置-1 class=headerlink title="Master 安装配置"></a>Master 安装配置</h5><ol><li><p>安装</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum install keepalived</span><br></pre></td></tr></table></figure></li><li><p>配置</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1.先备份原来的配置文件，然后开始配置</span></span><br><span class=line>vi /etc/keepalived/keepalived.conf</span><br><span class=line>! Configuration File <span class=keyword>for</span> keepalived</span><br><span class=line><span class=comment># 全局配置</span></span><br><span class=line>global_defs &#123;</span><br><span class=line>   router_id LVS_DEVEL_MASTER</span><br><span class=line>   script_user root</span><br><span class=line>   enable_script_security</span><br><span class=line>&#125;</span><br><span class=line><span class=comment># 健康检查脚本</span></span><br><span class=line>vrrp_script chk_maxscale &#123;</span><br><span class=line>    script <span class=string>&quot;/usr/bin/pidof  maxscale&quot;</span></span><br><span class=line>    interval 2</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=comment># 实例</span></span><br><span class=line>vrrp_instance VI_1 &#123;</span><br><span class=line>    state MASTER</span><br><span class=line>    interface enp0s3</span><br><span class=line>    virtual_router_id 120</span><br><span class=line>    priority 150</span><br><span class=line>    advert_int 1</span><br><span class=line>    authentication &#123;</span><br><span class=line>        auth_type PASS</span><br><span class=line>        auth_pass 1111</span><br><span class=line>    &#125;</span><br><span class=line>    virtual_ipaddress &#123;</span><br><span class=line>        192.168.56.120/24</span><br><span class=line>    &#125;</span><br><span class=line>    track_script &#123;</span><br><span class=line>      chk_maxscale</span><br><span class=line>    &#125;</span><br><span class=line>    <span class=comment># 调试用,配置好可删除</span></span><br><span class=line>    debug 1</span><br><span class=line>    <span class=comment># 通知脚本，用来改变MaxScale的passive的状态，防止多个MaxScale进行故障自动转移的操作</span></span><br><span class=line>    notify /etc/keepalived/scripts/notify_script.sh</span><br><span class=line></span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure></li><li><p>通知脚本，该脚本最好放在<code>/etc/keepalived/</code>目录下，其他目录需要额外处理权限</p></li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre></td><td class=code><pre><span class=line><span class=meta>#!/bin/bash</span></span><br><span class=line>TYPE=<span class=variable>$1</span></span><br><span class=line>NAME=<span class=variable>$2</span></span><br><span class=line>STATE=<span class=variable>$3</span></span><br><span class=line><span class=comment># 记录状态的文件</span></span><br><span class=line>OUTFILE=/etc/keepalived/scripts/state.txt</span><br><span class=line></span><br><span class=line><span class=keyword>case</span> <span class=variable>$STATE</span> <span class=keyword>in</span></span><br><span class=line> <span class=string>&quot;MASTER&quot;</span>) <span class=built_in>echo</span> <span class=string>&quot;Setting this MaxScale node to active mode&quot;</span> &gt; <span class=variable>$OUTFILE</span></span><br><span class=line>              <span class=comment>#/usr/bin/maxctrl alter maxscale passive false</span></span><br><span class=line>              <span class=built_in>exit</span> 0</span><br><span class=line>              ;;</span><br><span class=line> <span class=string>&quot;BACKUP&quot;</span>) <span class=built_in>echo</span> <span class=string>&quot;Setting this MaxScale node to passive mode&quot;</span> &gt; <span class=variable>$OUTFILE</span></span><br><span class=line>              <span class=comment>#/usr/bin/maxctrl alter maxscale passive true</span></span><br><span class=line>              <span class=built_in>exit</span> 0</span><br><span class=line>              ;;</span><br><span class=line> <span class=string>&quot;FAULT&quot;</span>)  <span class=built_in>echo</span> <span class=string>&quot;MaxScale failed the status check.&quot;</span> &gt; <span class=variable>$OUTFILE</span></span><br><span class=line>              <span class=comment>#/usr/bin/maxctrl alter maxscale passive true</span></span><br><span class=line>              <span class=built_in>exit</span> 0</span><br><span class=line>              ;;</span><br><span class=line>    *)     <span class=built_in>echo</span> <span class=string>&quot;Unknown state&quot;</span> &gt; <span class=variable>$OUTFILE</span></span><br><span class=line>              <span class=built_in>exit</span> 1</span><br><span class=line>              ;;</span><br><span class=line><span class=keyword>esac</span></span><br></pre></td></tr></table></figure><ol start=4><li><p><code>/etc/keepalived/scripts/notify_script.sh</code>脚本SELinux 权限配置</p><p>网上很多方法是关闭SELinux ，实在解决不了可以关闭掉SELinux ，最好是不关闭，多一层防护</p></li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>chcon -t keepalived_unconfined_script_exec_t /etc/keepalived/scripts/notify_script.sh</span><br><span class=line>chcon -t keepalived_unconfined_script_exec_t /etc/keepalived/scripts/state.txt</span><br></pre></td></tr></table></figure><ol start=5><li>开通防火墙</li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>firewall-cmd --add-protocol=vrrp --permanent</span><br><span class=line>firewall-cmd --reload</span><br></pre></td></tr></table></figure><ol start=6><li>启动</li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 启动</span></span><br><span class=line>systemctl start keepalived</span><br><span class=line><span class=comment># 加入开机自启动</span></span><br><span class=line>systemctl <span class=built_in>enable</span> keepalived</span><br></pre></td></tr></table></figure><h5 id=Backup-安装配置><a href=#Backup-安装配置 class=headerlink title="Backup 安装配置"></a>Backup 安装配置</h5><p>和Master唯一不同是第5点，直接通过下面的配置代码介绍</p><ol><li>backup的配置</li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br></pre></td><td class=code><pre><span class=line>global_defs &#123;</span><br><span class=line>   <span class=comment># router_id 不能和Master一样</span></span><br><span class=line>   router_id LVS_DEVEL_BACKUP</span><br><span class=line>   script_user root</span><br><span class=line>   enable_script_security</span><br><span class=line>&#125;</span><br><span class=line>vrrp_script chk_maxscale &#123;</span><br><span class=line>    script <span class=string>&quot;/usr/sbin/pidof  maxscale&quot;</span></span><br><span class=line>    interval 2</span><br><span class=line>&#125;</span><br><span class=line>vrrp_instance VI_1 &#123;</span><br><span class=line>    <span class=comment># 状态不一样，该机器是备机</span></span><br><span class=line>    state BACKUP</span><br><span class=line>    interface enp0s3</span><br><span class=line>    virtual_router_id 120</span><br><span class=line>    <span class=comment># 优先级不一样，要低于Master</span></span><br><span class=line>    priority 100</span><br><span class=line>    advert_int 1</span><br><span class=line>    authentication &#123;</span><br><span class=line>        auth_type PASS</span><br><span class=line>        auth_pass 1111</span><br><span class=line>    &#125;</span><br><span class=line>    virtual_ipaddress &#123;</span><br><span class=line>        192.168.56.120/24</span><br><span class=line>    &#125;</span><br><span class=line>    track_script &#123;</span><br><span class=line>      chk_maxscale</span><br><span class=line>    &#125;</span><br><span class=line>    debug 1</span><br><span class=line>    notify /etc/keepalived/scripts/notify_script.sh</span><br><span class=line>&#125;</span><br></pre></td></tr></table></figure><h5 id=测试><a href=#测试 class=headerlink title=测试></a>测试</h5><ol><li>首先分别监控keepalived master和backup 的日志</li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>journalctl -fu keepalived.service</span><br></pre></td></tr></table></figure><ol start=2><li><p>监控MaxScale Master 和 backup的 passive 值</p><p>master：</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 执行命令</span></span><br><span class=line>maxctrl show maxscale</span><br><span class=line><span class=comment># 结果中的关键信息</span></span><br><span class=line>┌──────────────┬──────────────────────────────────────────────────────────┐</span><br><span class=line>│ Version      │ 6.4.5                                                    │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Commit       │ e716c9cfc5f68f2e4ffada46c2d145918e7433bc                 │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Started At   │ Fri, 17 Mar 2023 14:07:19 GMT                            │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Activated At │ Fri, 17 Mar 2023 14:07:19 GMT                            │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Uptime       │ 1827                                                     │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Config Sync  │ null                                                     │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Parameters   │ &#123;                                                        │</span><br><span class=line>│              │     <span class=string>&quot;passive&quot;</span>: <span class=literal>false</span>,                                    │</span><br><span class=line>│              │     <span class=string>&quot;writeq_low_water&quot;</span>: 8192                             │</span><br><span class=line>│              │ &#125;                                                        │</span><br><span class=line>└──────────────┴──────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>backup:</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 执行命令</span></span><br><span class=line>maxctrl show maxscale</span><br><span class=line><span class=comment># 结果中的关键信息</span></span><br><span class=line>┌──────────────┬──────────────────────────────────────────────────────────┐</span><br><span class=line>│ Version      │ 6.4.5                                                    │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Commit       │ e716c9cfc5f68f2e4ffada46c2d145918e7433bc                 │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Started At   │ Fri, 17 Mar 2023 14:07:19 GMT                            │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Activated At │ Fri, 17 Mar 2023 14:07:19 GMT                            │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Uptime       │ 1827                                                     │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Config Sync  │ null                                                     │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Parameters   │ &#123;                                                        │</span><br><span class=line>│              │     <span class=string>&quot;passive&quot;</span>: <span class=literal>true</span> ,                                    │</span><br><span class=line>│              │     <span class=string>&quot;writeq_low_water&quot;</span>: 8192                             │</span><br><span class=line>│              │ &#125;                                                        │</span><br><span class=line>└──────────────┴──────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure></li><li><p>停掉Master 机器上的MaxScale 服务，观察keepalived master和backup 的日志情况</p></li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>systemctl stop maxscale</span><br></pre></td></tr></table></figure><p>keepalived master日志：结果显示进入了<code>Entering FAULT STATE</code></p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>Mar 17 22:42:38 msk_master Keepalived_vrrp[2597]: Script `chk_maxscale` now returning 1</span><br><span class=line>Mar 17 22:42:38 msk_master Keepalived_vrrp[2597]: VRRP_Script(chk_maxscale) failed (exited with status 1)</span><br><span class=line>Mar 17 22:42:38 msk_master Keepalived_vrrp[2597]: (VI_1) Entering FAULT STATE</span><br><span class=line>Mar 17 22:42:38 msk_master Keepalived_vrrp[2597]: (VI_1) sent 0 priority</span><br><span class=line>Mar 17 22:42:38 msk_master Keepalived_vrrp[2597]: (VI_1) removing VIPs.</span><br></pre></td></tr></table></figure><p>keepalived backup 日志：结果显示已经进入<code>Entering MASTER STATE</code></p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br></pre></td><td class=code><pre><span class=line>Mar 17 22:42:38 msk_slave Keepalived_vrrp[4215]: (VI_1) Backup received priority 0 advertisement</span><br><span class=line>Mar 17 22:42:38 msk_slave Keepalived_vrrp[4215]: (VI_1) Backup received priority 0 advertisement</span><br><span class=line>Mar 17 22:42:39 msk_slave Keepalived_vrrp[4215]: (VI_1) Receive advertisement timeout</span><br><span class=line>Mar 17 22:42:39 msk_slave Keepalived_vrrp[4215]: (VI_1) Entering MASTER STATE</span><br><span class=line>Mar 17 22:42:39 msk_slave Keepalived_vrrp[4215]: (VI_1) setting VIPs.</span><br><span class=line>Mar 17 22:42:39 msk_slave Keepalived_vrrp[4215]: (VI_1) Sending/queueing gratuitous ARPs on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:39 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:39 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:39 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:39 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:39 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:44 msk_slave Keepalived_vrrp[4215]: (VI_1) Sending/queueing gratuitous ARPs on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:44 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:44 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:44 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:44 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:42:44 msk_slave Keepalived_vrrp[4215]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br></pre></td></tr></table></figure><ol start=4><li>再查看MaxScale backup的状态</li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 执行命令</span></span><br><span class=line>maxctrl show maxscale</span><br><span class=line><span class=comment># 结果中的关键信息</span></span><br><span class=line>┌──────────────┬──────────────────────────────────────────────────────────┐</span><br><span class=line>│ Version      │ 6.4.5                                                    │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Commit       │ e716c9cfc5f68f2e4ffada46c2d145918e7433bc                 │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Started At   │ Fri, 17 Mar 2023 14:07:19 GMT                            │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Activated At │ Fri, 17 Mar 2023 14:07:19 GMT                            │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Uptime       │ 1827                                                     │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Config Sync  │ null                                                     │</span><br><span class=line>├──────────────┼──────────────────────────────────────────────────────────┤</span><br><span class=line>│ Parameters   │ &#123;                                                        │</span><br><span class=line>│              │     <span class=string>&quot;passive&quot;</span>: <span class=literal>false</span>,                                    │</span><br><span class=line>│              │     <span class=string>&quot;writeq_low_water&quot;</span>: 8192                             │</span><br><span class=line>│              │ &#125;                                                        │</span><br><span class=line>└──────────────┴──────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><ol start=5><li><p>再启动MaxScale Master服务，继续观察日志，可以看到之前的keepalived master 又恢复到了master状态，keepalived backup 也恢复到back状态</p><p>keepalived master日志：</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre></td><td class=code><pre><span class=line>Mar 17 22:48:46 msk_master Keepalived_vrrp[2597]: Script `chk_maxscale` now returning 0</span><br><span class=line>Mar 17 22:48:46 msk_master Keepalived_vrrp[2597]: VRRP_Script(chk_maxscale) succeeded</span><br><span class=line>Mar 17 22:48:46 msk_master Keepalived_vrrp[2597]: (VI_1) Entering BACKUP STATE</span><br><span class=line>Mar 17 22:48:47 msk_master Keepalived_vrrp[2597]: (VI_1) received lower priority (100) advert from 192.168.56.119 - discarding</span><br><span class=line>Mar 17 22:48:48 msk_master Keepalived_vrrp[2597]: (VI_1) received lower priority (100) advert from 192.168.56.119 - discarding</span><br><span class=line>Mar 17 22:48:49 msk_master Keepalived_vrrp[2597]: (VI_1) received lower priority (100) advert from 192.168.56.119 - discarding</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: (VI_1) received lower priority (100) advert from 192.168.56.119 - discarding</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: (VI_1) Receive advertisement timeout</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: (VI_1) Entering MASTER STATE</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: (VI_1) setting VIPs.</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: (VI_1) Sending/queueing gratuitous ARPs on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:50 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:55 msk_master Keepalived_vrrp[2597]: (VI_1) Sending/queueing gratuitous ARPs on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:55 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:55 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:55 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:55 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br><span class=line>Mar 17 22:48:55 msk_master Keepalived_vrrp[2597]: Sending gratuitous ARP on enp0s3 <span class=keyword>for</span> 192.168.56.120</span><br></pre></td></tr></table></figure><p>keepalived backup 日志：</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br></pre></td><td class=code><pre><span class=line>Mar 17 22:48:50 msk_slave Keepalived_vrrp[4215]: (VI_1) Master received advert from 192.168.56.118 with higher priority 150, ours 100</span><br><span class=line>Mar 17 22:48:50 msk_slave Keepalived_vrrp[4215]: (VI_1) Entering BACKUP STATE</span><br><span class=line>Mar 17 22:48:50 msk_slave Keepalived_vrrp[4215]: (VI_1) removing VIPs.</span><br></pre></td></tr></table></figure></li></ol><h4 id=结语><a href=#结语 class=headerlink title=结语></a>结语</h4><p>算算刚刚起步，开始用起来！</p><h4 id=参考资料><a href=#参考资料 class=headerlink title=参考资料></a>参考资料</h4><ol><li><a target=_blank rel=noopener href=https://unix.stackexchange.com/questions/102558/mysql-permission-denied-error-even-after-setting-security-context-for-selinux-on>MySQL permission denied error even after setting security context for SELinux on VM</a></li><li><a target=_blank rel=noopener href=https://github.com/malongshuai/proxysql/wiki>中文文档</a></li><li><a target=_blank rel=noopener href=https://stackoverflow.com/questions/70923232/keepalived-notify-not-running-the-script>Keepalived notify not running the script</a></li></ol></div><footer class=post-footer><div class=post-tags><a href=/tags/HA/ rel=tag># HA</a> <a href=/tags/High-Availability/ rel=tag># High Availability</a> <a href=/tags/MariaDB/ rel=tag># MariaDB</a></div><div class=post-nav><div class=post-nav-item><a href=/2023/03/04/mysql/mysql-ha/ rel=prev title=搭建MySQL读写分离、高可用><i class="fa fa-chevron-left"></i> 搭建MySQL读写分离、高可用</a></div><div class=post-nav-item><a href=/2023/07/17/my/covid-19/ rel=next title=感染新冠(2023-06-09)>感染新冠(2023-06-09) <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments gitalk-container"></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; 2017 – <span itemprop=copyrightYear>2025</span> <span class=with-love><i class="fa fa-user"></i> </span><span class=author itemprop=copyrightHolder>TungSing</span></div></div></footer><script src=https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/next-boot.js></script><script src=/js/pjax.js></script><script src=https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin=anonymous></script><script src=/js/third-party/search/local-search.js></script><script src=/js/third-party/fancybox.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin=anonymous><script class=next-config data-name=gitalk type=application/json>{"enable":true,"github_id":"tungSing","repo":"tungsing.github.io","client_id":"52a90bdfc66139c7ae8d","client_secret":"cf1297a36b1ca9ee630211520789e614a202d310","admin_user":"tungSing","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":null,"js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"201fc2f9690bd9ae20ddeffc2762071a"}</script><script src=/js/third-party/comments/gitalk.js></script><script src=/js/third-party/photo/lazyload.js></script><script src=/js/third-party/photo/minigrid.min.js></script><script data-pjax src=/js/third-party/photo/photo.js></script></body></html>