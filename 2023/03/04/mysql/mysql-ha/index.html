<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content=#222><meta name=generator content="Hexo 6.0.0"><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon-next.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32-next.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16-next.png><link rel=mask-icon href=/images/logo.svg color=#222><link rel=stylesheet href=/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CLobster+Two:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><script class=next-config data-name=main type=application/json>{"hostname":"tungsing.cc","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src=/js/config.js></script><meta name=description content="前言 在做基础脚手架开发的过程中涉及到代码要不要支持读写分离，支持的话的需要一定的工作量，虽然代码不多，也比较容易实现，但毕竟需要维护。为了避免重新写轮子，先查询。还有真有不少解决方案，第一种就是基于应用的，自己在应用程序中编码实现；第二种就是基于中间件，有MySQL Proxy、MaxScale和HAProxy等，MySQL Proxy已经不维护了；HAProxy本身不支持读写分离，还需要搭配其"><meta property=og:type content=article><meta property=og:title content=搭建MySQL读写分离、高可用><meta property=og:url content=http://tungsing.cc/2023/03/04/mysql/mysql-ha/index.html><meta property=og:site_name content="TungSing&#39;s Blog"><meta property=og:description content="前言 在做基础脚手架开发的过程中涉及到代码要不要支持读写分离，支持的话的需要一定的工作量，虽然代码不多，也比较容易实现，但毕竟需要维护。为了避免重新写轮子，先查询。还有真有不少解决方案，第一种就是基于应用的，自己在应用程序中编码实现；第二种就是基于中间件，有MySQL Proxy、MaxScale和HAProxy等，MySQL Proxy已经不维护了；HAProxy本身不支持读写分离，还需要搭配其"><meta property=og:locale content=zh_CN><meta property=og:image content=http://tungsing.cc/images/book/design_pattern.jpg><meta property=article:published_time content=2023-03-04T13:24:20.407Z><meta property=article:modified_time content=2023-03-20T09:57:26.910Z><meta property=article:author content=tungSing><meta property=article:tag content=HA><meta property=article:tag content="High Availability"><meta property=article:tag content=MySQL><meta name=twitter:card content=summary><meta name=twitter:image content=http://tungsing.cc/images/book/design_pattern.jpg><link rel=canonical href=http://tungsing.cc/2023/03/04/mysql/mysql-ha/ ><script class=next-config data-name=page type=application/json>{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://tungsing.cc/2023/03/04/mysql/mysql-ha/","path":"2023/03/04/mysql/mysql-ha/","title":"搭建MySQL读写分离、高可用"}</script><script class=next-config data-name=calendar type=application/json>""</script><title>搭建MySQL读写分离、高可用 | TungSing's Blog</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript><link rel=alternate href=/atom.xml title="TungSing's Blog" type=application/atom+xml></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><p class=site-title>TungSing's Blog</p><i class=logo-line></i></a><p class=site-subtitle itemprop=description>用心记录一切！</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ rel=section><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href=/tags/ rel=section><i class="fa fa-tags fa-fw"></i>标签<span class=badge>70</span></a></li><li class="menu-item menu-item-categories"><a href=/categories/ rel=section><i class="fa fa-th fa-fw"></i>分类<span class=badge>10</span></a></li><li class="menu-item menu-item-archives"><a href=/archives/ rel=section><i class="fa fa-archive fa-fw"></i>归档<span class=badge>55</span></a></li><li class="menu-item menu-item-photos"><a href=/photos/ rel=section><i class="fa fa-image fa-fw"></i>相册</a></li><li class="menu-item menu-item-about"><a href=/about/ rel=section><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-search"><a role=button class=popup-trigger><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span> <span class=toggle-line></span> <span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class=nav><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%89%8D%E8%A8%80><span class=nav-number>1.</span> <span class=nav-text>前言</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%8E%AF%E5%A2%83><span class=nav-number>2.</span> <span class=nav-text>环境</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92><span class=nav-number>3.</span> <span class=nav-text>环境规划</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#MySQL-%E4%B8%BB%E4%BB%8E%E6%90%AD%E5%BB%BA><span class=nav-number>4.</span> <span class=nav-text>MySQL 主从搭建</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#Master-%E5%AE%89%E8%A3%85><span class=nav-number>4.1.</span> <span class=nav-text>Master 安装</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#Slave-%E5%AE%89%E8%A3%85><span class=nav-number>4.2.</span> <span class=nav-text>Slave 安装</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#%E6%90%AD%E5%BB%BA%E9%85%8D%E7%BD%AE><span class=nav-number>4.3.</span> <span class=nav-text>搭建配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#MaxScale-%E6%90%AD%E5%BB%BA><span class=nav-number>5.</span> <span class=nav-text>MaxScale 搭建</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#Master-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE><span class=nav-number>5.1.</span> <span class=nav-text>Master 安装配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#ProxySQL-%E6%90%AD%E5%BB%BA><span class=nav-number>6.</span> <span class=nav-text>ProxySQL 搭建</span></a><ol class=nav-child><li class="nav-item nav-level-5"><a class=nav-link href=#Node-1-%E6%90%AD%E5%BB%BA><span class=nav-number>6.1.</span> <span class=nav-text>Node 1 搭建</span></a></li><li class="nav-item nav-level-5"><a class=nav-link href=#ProxySQL-%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E><span class=nav-number>6.2.</span> <span class=nav-text>ProxySQL 配置说明</span></a></li></ol></li><li class="nav-item nav-level-4"><a class=nav-link href=#%E7%BB%93%E8%AF%AD><span class=nav-number>7.</span> <span class=nav-text>结语</span></a></li><li class="nav-item nav-level-4"><a class=nav-link href=#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99><span class=nav-number>8.</span> <span class=nav-text>参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><p class=site-author-name itemprop=name>tungSing</p><div class=site-description itemprop=description>多读书多看报</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/ ><span class=site-state-item-count>55</span> <span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/ ><span class=site-state-item-count>10</span> <span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/ ><span class=site-state-item-count>70</span> <span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class=links-of-author-item><a href=https://github.com/tungsing title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tungsing" rel=noopener target=_blank><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class=links-of-author-item><a href=https://twitter.com/dongsheng__gao title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;dongsheng__gao" rel=noopener target=_blank><i class="fab fa-twitter fa-fw"></i>Twitter</a></span></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=back-to-top role=button aria-label=返回顶部><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang=zh-CN><link itemprop=mainEntityOfPage href=http://tungsing.cc/2023/03/04/mysql/mysql-ha/ ><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content=/images/avatar.gif><meta itemprop=name content=tungSing><meta itemprop=description content=多读书多看报></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="TungSing's Blog"></span><header class=post-header><h1 class=post-title itemprop="name headline">搭建MySQL读写分离、高可用</h1><div class=post-meta-container><div class=post-meta><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i> </span><span class=post-meta-item-text>发表于</span> <time title="创建时间：2023-03-04 13:24:20" itemprop="dateCreated datePublished" datetime=2023-03-04T13:24:20Z>2023-03-04</time> </span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar-check"></i> </span><span class=post-meta-item-text>更新于</span> <time title="修改时间：2023-03-20 09:57:26" itemprop=dateModified datetime=2023-03-20T09:57:26Z>2023-03-20</time> </span><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder"></i> </span><span class=post-meta-item-text>分类于</span> <span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/database/ itemprop=url rel=index><span itemprop=name>database</span></a></span></span></div></div></header><div class=post-body itemprop=articleBody><h4 id=前言><a href=#前言 class=headerlink title=前言></a>前言</h4><blockquote><p>在做基础脚手架开发的过程中涉及到代码要不要支持读写分离，支持的话的需要一定的工作量，虽然代码不多，也比较容易实现，但毕竟需要维护。为了避免重新写轮子，先查询。还有真有不少解决方案，第一种就是基于应用的，自己在应用程序中编码实现；第二种就是基于中间件，有MySQL Proxy、MaxScale和HAProxy等，MySQL Proxy已经不维护了；HAProxy本身不支持读写分离，还需要搭配其他才能实现；MaxScale 文档比较全，并且是MariaDB 开发的，所以先用起来看看效果。</p></blockquote><p><img src=/images/book/design_pattern.jpg></p><span id=more></span><h4 id=环境><a href=#环境 class=headerlink title=环境></a>环境</h4><ul><li>Linux rocky 8</li><li>MySQL 5.7</li><li>MariaDB MaxScale 6.4</li><li>ProxySQL 2.4.8</li></ul><h4 id=环境规划><a href=#环境规划 class=headerlink title=环境规划></a>环境规划</h4><table><thead><tr><th align=center>序号</th><th>应用</th><th>hostname</th><th>IP</th><th>端口</th></tr></thead><tbody><tr><td align=center>1</td><td>MySQL Master</td><td></td><td>192.168.56.100</td><td>3306</td></tr><tr><td align=center>2</td><td>MySQL Slave</td><td></td><td>192.168.56.101</td><td>3306</td></tr><tr><td align=center>3</td><td>MaxScale</td><td></td><td>192.168.56.102</td><td>4006/8989</td></tr><tr><td align=center>4</td><td>ProxySQL</td><td></td><td>192.168.56.103</td><td>6033</td></tr></tbody></table><h4 id=MySQL-主从搭建><a href=#MySQL-主从搭建 class=headerlink title="MySQL 主从搭建"></a>MySQL 主从搭建</h4><h5 id=Master-安装><a href=#Master-安装 class=headerlink title="Master 安装"></a>Master 安装</h5><ol><li><p>下载安装包</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>wget https://cdn.mysql.com/archives/mysql-5.7/mysql-5.7.40-1.el7.x86_64.rpm-bundle.tar</span><br><span class=line>tar -xvf mysql-5.7.40-1.el7.x86_64.rpm-bundle.tar</span><br></pre></td></tr></table></figure></li><li><p>检查是否之前是否有安装，有删除</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>yum list installed | grep -i maria</span><br><span class=line>yum list installed | grep -i mysql</span><br></pre></td></tr></table></figure></li><li><p>安装</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum install mysql-community-&#123;server,client,common,libs&#125;-* --exclude=<span class=string>&#x27;*minimal*&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>修改默认数据目录，</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 创建目录</span></span><br><span class=line>mkdir /home/mysql_data</span><br><span class=line><span class=comment># 2. 拷贝目录数据目录</span></span><br><span class=line>cp -a /var/lib/mysql /home/mysql_data/</span><br><span class=line><span class=comment># 3. 修改MySQL配置文件</span></span><br><span class=line>vi /etc/my.cnf</span><br><span class=line><span class=comment># 4. 需要修改的内容</span></span><br><span class=line>datadir=/home/mysql_data/mysql</span><br><span class=line>socket=/home/mysql_data/mysql/mysql.sock</span><br><span class=line>[client]</span><br><span class=line>socket=/home/mysql_data/mysql/mysql.sock</span><br></pre></td></tr></table></figure></li><li><p>修改SELinux对MySQL默认数据目录的保护</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 打开/etc/selinux/targeted/contexts/files/file_contexts.local</span></span><br><span class=line>vi /etc/selinux/targeted/contexts/files/file_contexts.local</span><br><span class=line><span class=comment># 2. 添加以下内容</span></span><br><span class=line>/home/mysql_data(/.*)?   system_u:object_r:mysqld_db_t:s0</span><br></pre></td></tr></table></figure></li><li><p>启动MySQL</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 启动</span></span><br><span class=line>systemctl start mysqld</span><br><span class=line><span class=comment># 开启自启动</span></span><br><span class=line>systemctl <span class=built_in>enable</span> mysqld</span><br></pre></td></tr></table></figure></li><li><p>找到<code>root</code>的默认密码</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>grep <span class=string>&#x27;A temporary password&#x27;</span> /var/<span class=built_in>log</span>/mysqld.log |tail -1</span><br></pre></td></tr></table></figure></li><li><p>修改默认密码</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 登陆到MySQL Server</span></span><br><span class=line>mysql -uroot -p</span><br><span class=line><span class=comment># 设置密码</span></span><br><span class=line>ALTER USER <span class=string>&#x27;root&#x27;</span>@<span class=string>&#x27;localhost&#x27;</span> IDENTIFIED BY <span class=string>&#x27;password&#x27;</span>;</span><br></pre></td></tr></table></figure></li></ol><h5 id=Slave-安装><a href=#Slave-安装 class=headerlink title="Slave 安装"></a>Slave 安装</h5><p>同master</p><h5 id=搭建配置><a href=#搭建配置 class=headerlink title=搭建配置></a>搭建配置</h5><ol><li><p>修改master的<code>my.cnf</code>配置文件</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br></pre></td><td class=code><pre><span class=line><span class=comment># server id 唯一</span></span><br><span class=line>server_id=112</span><br><span class=line><span class=comment># GTID 模式</span></span><br><span class=line>gtid-mode = ON</span><br><span class=line><span class=comment># 强制GTID一致性</span></span><br><span class=line>enforce-gtid-consistency = ON</span><br><span class=line><span class=comment># 是否记录从服务器同步数据动作</span></span><br><span class=line>log-slave-updates=ON</span><br><span class=line><span class=comment># 开启及设置二进制日志文件名称</span></span><br><span class=line>log_bin=mysql-bin</span><br><span class=line><span class=comment># 设置binlog文件格式</span></span><br><span class=line>binlog_format=MIXED</span><br><span class=line></span><br><span class=line><span class=comment># 记录IO线程读取已经读取到的master binlog位置，用于slave宕机后IO线程根据文件中的POS点重新拉取binlog日志</span></span><br><span class=line>master-info-repository = TABLE</span><br><span class=line><span class=comment># 记录SQL线程读取Master binlog的位置，用于Slave 宕机后根据文件中记录的pos点恢复Sql线程</span></span><br><span class=line>relay-log-info-repository = TABLE   </span><br><span class=line><span class=comment># 启用确保无信息丢失；任何一个事务提交后, 将二进制日志的文件名及事件位置记录到文件中</span></span><br><span class=line>sync-master-info = 1</span><br><span class=line><span class=comment># 设定从服务器的复制线程数；0表示关闭多线程复制功能</span></span><br><span class=line>slave-parallel-workers = 2</span><br><span class=line><span class=comment># 设置binlog校验算法（循环冗余校验码）</span></span><br><span class=line>binlog-checksum = CRC32</span><br><span class=line><span class=comment># 设置主服务器是否校验</span></span><br><span class=line>master-verify-checksum = 1</span><br><span class=line><span class=comment># 设置从服务器是否校验</span></span><br><span class=line>slave-sql-verify-checksum = 1</span><br><span class=line><span class=comment># 用于在二进制日志记录事件相关的信息，可降低故障排除的复杂度</span></span><br><span class=line>binlog-rows-query-log_events = 1</span><br><span class=line><span class=comment># 保证master crash safe，该参数必须设置为1</span></span><br><span class=line>sync_binlog = 1</span><br><span class=line><span class=comment># 保证master crash safe，该参数必须设置为1</span></span><br><span class=line>innodb_flush_log_at_trx_commit = 1   </span><br></pre></td></tr></table></figure></li><li><p>重启MySQL Server</p></li><li><p>添加同步用户</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>GRANT REPLICATION SLAVE,RELOAD,SUPER ON *.* TO sync@<span class=string>&#x27;192.168.56.%&#x27;</span> IDENTIFIED BY <span class=string>&#x27;password&#x27;</span>;</span><br><span class=line>FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure></li><li><p>查看master 状态并记录下位置信息</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show master status;</span><br><span class=line>+------------------+----------+--------------+-------------------------------------------------+-------------------+</span><br><span class=line>| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB                                | Executed_Gtid_Set |</span><br><span class=line>+------------------+----------+--------------+-------------------------------------------------+-------------------+</span><br><span class=line>| mysql-bin.000008 |      154 |              | sys,mysql,information_schema,performance_schema |                   |</span><br><span class=line>+------------------+----------+--------------+-------------------------------------------------+-------------------+</span><br><span class=line>1 row <span class=keyword>in</span> <span class=built_in>set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>修改slave的<code>my.cnf</code> 配置文件</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br></pre></td><td class=code><pre><span class=line><span class=comment># server id 唯一</span></span><br><span class=line>server-id=113</span><br><span class=line><span class=comment># GTID 模式</span></span><br><span class=line>gtid-mode = ON</span><br><span class=line><span class=comment># 强制GTID一致性</span></span><br><span class=line>enforce-gtid-consistency = ON</span><br><span class=line><span class=comment># 是否记录从服务器同步数据动作</span></span><br><span class=line>log-slave-updates=ON</span><br><span class=line><span class=comment># 开启及设置二进制日志文件名称</span></span><br><span class=line>log_bin=mysql-bin</span><br><span class=line><span class=comment># 设置binlog文件格式</span></span><br><span class=line>binlog_format=MIXED</span><br><span class=line><span class=comment># 设置一般用户为只读模式</span></span><br><span class=line>read-only=1</span><br><span class=line></span><br><span class=line>master-info-repository = TABLE</span><br><span class=line>relay-log-info-repository = TABLE</span><br><span class=line>sync-master-info = 1</span><br><span class=line>slave-parallel-workers = 4</span><br><span class=line>binlog-checksum = CRC32</span><br><span class=line>master-verify-checksum = 1</span><br><span class=line>slave-sql-verify-checksum = 1</span><br><span class=line>binlog-rows-query-log_events = 1</span><br><span class=line><span class=comment># crash safe slave</span></span><br><span class=line>relay_log_recovery = 1</span><br></pre></td></tr></table></figure></li><li><p>重启MySQL Server</p></li><li><p>打开master 防火墙的3306 端口</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br></pre></td><td class=code><pre><span class=line>firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class=line>firewall-cmd --reload</span><br></pre></td></tr></table></figure></li><li><p>配置从主库同步数据</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 登陆MySQL slave Server</span></span><br><span class=line>mysql -uroot -p</span><br><span class=line><span class=comment># 2. 配置</span></span><br><span class=line><span class=comment># MASTER_LOG_FILE 和 MASTER_LOG_POS 的值就是从 主库 show master status 命令中获取的信息</span></span><br><span class=line>mysql&gt; CHANGE MASTER TO MASTER_HOST=<span class=string>&#x27;192.168.56.115&#x27;</span>,</span><br><span class=line>       MASTER_USER=<span class=string>&#x27;sync&#x27;</span>,</span><br><span class=line>       MASTER_PASSWORD=<span class=string>&#x27;password&#x27;</span>,</span><br><span class=line>       MASTER_AUTO_POSITION=1;</span><br><span class=line><span class=comment># 3. 开启同步</span></span><br><span class=line>mysql&gt; start slave;</span><br></pre></td></tr></table></figure></li><li><p>查看同步情况</p></li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br></pre></td><td class=code><pre><span class=line>mysql&gt; show slave status\G</span><br><span class=line><span class=comment># 检查以下参数都是 Yes 代表正常</span></span><br><span class=line>Slave_IO_Running: Yes</span><br><span class=line>Slave_SQL_Running: Yes</span><br><span class=line></span><br></pre></td></tr></table></figure><ol start=10><li>测试，通过创建数据库、表，添加数据来看同步是否正常</li></ol><h4 id=MaxScale-搭建><a href=#MaxScale-搭建 class=headerlink title="MaxScale 搭建"></a>MaxScale 搭建</h4><h5 id=Master-安装配置><a href=#Master-安装配置 class=headerlink title="Master 安装配置"></a>Master 安装配置</h5><ol><li><p>通过<a target=_blank rel=noopener href=https://mariadb.com/downloads/community/maxscale/ >官网</a>下载安装包</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>wget https://dlm.mariadb.com/2717592/MaxScale/6.4.5/yum/centos/8/x86_64/maxscale-6.4.5-1.rhel.8.x86_64.rpm</span><br></pre></td></tr></table></figure></li><li><p>安装</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum install maxscale-6.4.5-1.rhel.8.x86_64.rpm</span><br></pre></td></tr></table></figure></li><li><p>在MySQL Master 上添加监控和路由用户</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 连接MySQL Server</span></span><br><span class=line>mysql -uroot -p</span><br><span class=line><span class=comment># 2. 添加监控用户</span></span><br><span class=line>grant replication slave,replication client on *.* to <span class=string>&#x27;maxmon&#x27;</span>@<span class=string>&#x27;192.168.56.%&#x27;</span> identified by <span class=string>&#x27;password&#x27;</span>;</span><br><span class=line><span class=comment># 3. 添加路由用户</span></span><br><span class=line>grant select on mysql.* to <span class=string>&#x27;maxrou&#x27;</span>@<span class=string>&#x27;192.168.56.%&#x27;</span> identified by <span class=string>&#x27;password&#x27;</span>;</span><br><span class=line><span class=comment># 4. 刷新权限信息</span></span><br><span class=line>flush privileges;</span><br></pre></td></tr></table></figure></li><li><p>读写分离配置，具体可阅读<a target=_blank rel=noopener href=https://github.com/mariadb-corporation/MaxScale/blob/6.4.5/Documentation/Documentation-Contents.md>官方配置</a></p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 打开配置文件</span></span><br><span class=line>vim /etc/maxscale.cnf</span><br><span class=line><span class=comment># 2. 配置</span></span><br><span class=line><span class=comment># 基础配置</span></span><br><span class=line>[maxscale]</span><br><span class=line>threads=auto</span><br><span class=line>admin_host=0.0.0.0</span><br><span class=line>admin_secure_gui=<span class=literal>false</span></span><br><span class=line></span><br><span class=line><span class=comment># MySQL Server 配置</span></span><br><span class=line>[server1]</span><br><span class=line><span class=built_in>type</span>=server</span><br><span class=line>address=192.168.56.112</span><br><span class=line>port=3306</span><br><span class=line>protocol=MySQLBackend</span><br><span class=line></span><br><span class=line>[server2]</span><br><span class=line><span class=built_in>type</span>=server</span><br><span class=line>address=192.168.56.113</span><br><span class=line>port=3306</span><br><span class=line>protocol=MySQLBackend</span><br><span class=line><span class=comment># 监控配置</span></span><br><span class=line>[MariaDB-Monitor]</span><br><span class=line><span class=built_in>type</span>=monitor</span><br><span class=line>module=mariadbmon</span><br><span class=line>servers=server1,server2</span><br><span class=line>user=maxmon</span><br><span class=line>password=password</span><br><span class=line>monitor_interval=2000</span><br><span class=line><span class=comment># 过滤器配置</span></span><br><span class=line><span class=comment># 非必须配置，是我使用的客户端工具默认会执行解释计划，但默认explain plan 会被路由到从库</span></span><br><span class=line>[Named-Server-Filter]</span><br><span class=line><span class=built_in>type</span>=filter</span><br><span class=line>module=namedserverfilter</span><br><span class=line>match01=^explain.*</span><br><span class=line>target01=server1</span><br><span class=line></span><br><span class=line><span class=comment># 读写分离服务配置</span></span><br><span class=line>[Read-Write-Service]</span><br><span class=line><span class=built_in>type</span>=service</span><br><span class=line>router=readwritesplit</span><br><span class=line>servers=server1,server2</span><br><span class=line>user=maxrou</span><br><span class=line>password=password</span><br><span class=line>filters=Named-Server-Filter</span><br><span class=line></span><br><span class=line><span class=comment># 读写分离监听配置</span></span><br><span class=line>[Read-Write-Listener]</span><br><span class=line><span class=built_in>type</span>=listener</span><br><span class=line>service=Read-Write-Service</span><br><span class=line>protocol=MySQLClient</span><br><span class=line>port=4006</span><br></pre></td></tr></table></figure></li><li><p>启动MaxScale</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 启动</span></span><br><span class=line>systemctl start maxscale</span><br><span class=line><span class=comment># 加入开机自启动</span></span><br><span class=line>systemctl <span class=built_in>enable</span> maxscale</span><br></pre></td></tr></table></figure></li><li><p>测试</p><p>用MySQL客户端或者命令连接上MaxScale，对数据库的表进行添加和查询数据，观察read/write值的变化</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 通过命令监控 read/write 的数量变化</span></span><br><span class=line>maxctrl show services</span><br><span class=line><span class=comment># 结果</span></span><br><span class=line>│ Router Diagnostics  │ &#123;                                                           │</span><br><span class=line>│                     │     <span class=string>&quot;avg_sescmd_history_length&quot;</span>: 0,                         │</span><br><span class=line>│                     │     <span class=string>&quot;max_sescmd_history_length&quot;</span>: 32,                        │</span><br><span class=line>│                     │     <span class=string>&quot;queries&quot;</span>: 117,                                         │</span><br><span class=line>│                     │     <span class=string>&quot;replayed_transactions&quot;</span>: 0,                             │</span><br><span class=line>│                     │     <span class=string>&quot;ro_transactions&quot;</span>: 0,                                   │</span><br><span class=line>│                     │     <span class=string>&quot;route_all&quot;</span>: 33,                                        │</span><br><span class=line>│                     │     <span class=string>&quot;route_master&quot;</span>: 9,                                      │</span><br><span class=line>│                     │     <span class=string>&quot;route_slave&quot;</span>: 75,                                      │</span><br><span class=line>│                     │     <span class=string>&quot;rw_transactions&quot;</span>: 0,                                   │</span><br><span class=line>│                     │     <span class=string>&quot;server_query_statistics&quot;</span>: [                            │</span><br><span class=line>│                     │         &#123;                                                   │</span><br><span class=line>│                     │             <span class=string>&quot;avg_selects_per_session&quot;</span>: 0,                   │</span><br><span class=line>│                     │             <span class=string>&quot;avg_sess_duration&quot;</span>: <span class=string>&quot;0ns&quot;</span>,                     │</span><br><span class=line>│                     │             <span class=string>&quot;id&quot;</span>: <span class=string>&quot;server1&quot;</span>,                                │</span><br><span class=line>│                     │             <span class=string>&quot;read&quot;</span>: 33,                                     │</span><br><span class=line>│                     │             <span class=string>&quot;total&quot;</span>: 42,                                    │</span><br><span class=line>│                     │             <span class=string>&quot;write&quot;</span>: 9                                      │</span><br><span class=line>│                     │         &#125;,                                                  │</span><br><span class=line>│                     │         &#123;                                                   │</span><br><span class=line>│                     │             <span class=string>&quot;avg_selects_per_session&quot;</span>: 0,                   │</span><br><span class=line>│                     │             <span class=string>&quot;avg_sess_duration&quot;</span>: <span class=string>&quot;0ns&quot;</span>,                     │</span><br><span class=line>│                     │             <span class=string>&quot;id&quot;</span>: <span class=string>&quot;server2&quot;</span>,                                │</span><br><span class=line>│                     │             <span class=string>&quot;read&quot;</span>: 108,                                    │</span><br><span class=line>│                     │             <span class=string>&quot;total&quot;</span>: 108,                                   │</span><br><span class=line>│                     │             <span class=string>&quot;write&quot;</span>: 0                                      │</span><br><span class=line>│                     │         &#125;                                                   │</span><br><span class=line>│                     │     ]                                                       │</span><br><span class=line>│                     │ &#125; </span><br><span class=line></span><br><span class=line><span class=comment># 2. 通过MaxGUI监控 http://127.0.0.1:8989</span></span><br></pre></td></tr></table></figure></li><li><p>注意</p><p>MaxScale 不支持MySQL的故障自动转移</p></li></ol><h4 id=ProxySQL-搭建><a href=#ProxySQL-搭建 class=headerlink title="ProxySQL 搭建"></a>ProxySQL 搭建</h4><h5 id=Node-1-搭建><a href=#Node-1-搭建 class=headerlink title="Node 1 搭建"></a>Node 1 搭建</h5><ol><li><p>通过<a target=_blank rel=noopener href=https://github.com/sysown/proxysql>github</a>下载安装包</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>wget https://github.com/sysown/proxysql/releases/download/v2.4.8/proxysql-2.4.8-1-centos8.x86_64.rpm</span><br></pre></td></tr></table></figure></li><li><p>安装</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum install proxysql-2.4.8-1-centos8.x86_64.rpm</span><br></pre></td></tr></table></figure></li><li><p>在MySQL Master 上添加监控用户和测试用户</p><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br></pre></td><td class=code><pre><span class=line># <span class=number>1.</span> 连接MySQL Server</span><br><span class=line>mysql <span class=operator>-</span>uroot <span class=operator>-</span>p</span><br><span class=line># <span class=number>2.</span> 添加监控用户</span><br><span class=line><span class=keyword>grant</span> replication slave,replication client <span class=keyword>on</span> <span class=operator>*</span>.<span class=operator>*</span> <span class=keyword>to</span> <span class=string>&#x27;maxmon&#x27;</span>@<span class=string>&#x27;192.168.56.%&#x27;</span> identified <span class=keyword>by</span> <span class=string>&#x27;password&#x27;</span>;</span><br><span class=line># <span class=number>3.</span> 测试用户</span><br><span class=line><span class=keyword>grant</span> <span class=keyword>all</span> <span class=keyword>on</span> ivy_base.<span class=operator>*</span> <span class=keyword>to</span> <span class=string>&#x27;ivy_base&#x27;</span>@<span class=string>&#x27;%&#x27;</span> identified <span class=keyword>by</span> <span class=string>&#x27;password&#x27;</span>;</span><br><span class=line># <span class=number>3.</span> 刷新权限信息</span><br><span class=line>flush privileges;</span><br></pre></td></tr></table></figure></li><li><p>读写分离配置</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br><span class=line>38</span><br><span class=line>39</span><br><span class=line>40</span><br><span class=line>41</span><br><span class=line>42</span><br><span class=line>43</span><br><span class=line>44</span><br><span class=line>45</span><br><span class=line>46</span><br><span class=line>47</span><br><span class=line>48</span><br><span class=line>49</span><br><span class=line>50</span><br><span class=line>51</span><br><span class=line>52</span><br><span class=line>53</span><br><span class=line>54</span><br><span class=line>55</span><br><span class=line>56</span><br><span class=line>57</span><br><span class=line>58</span><br><span class=line>59</span><br><span class=line>60</span><br><span class=line>61</span><br><span class=line>62</span><br><span class=line>63</span><br><span class=line>64</span><br><span class=line>65</span><br><span class=line>66</span><br><span class=line>67</span><br><span class=line>68</span><br><span class=line>69</span><br><span class=line>70</span><br><span class=line>71</span><br><span class=line>72</span><br><span class=line>73</span><br><span class=line>74</span><br><span class=line>75</span><br><span class=line>76</span><br><span class=line>77</span><br><span class=line>78</span><br><span class=line>79</span><br><span class=line>80</span><br><span class=line>81</span><br><span class=line>82</span><br><span class=line>83</span><br><span class=line>84</span><br><span class=line>85</span><br><span class=line>86</span><br><span class=line>87</span><br><span class=line>88</span><br><span class=line>89</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 打开配置文件</span></span><br><span class=line>vi /etc/proxysql.cnf</span><br><span class=line><span class=comment># 2. 配置</span></span><br><span class=line><span class=comment># 数据目录和日志文件</span></span><br><span class=line>datadir=<span class=string>&quot;/var/lib/proxysql&quot;</span></span><br><span class=line>errorlog=<span class=string>&quot;/var/lib/proxysql/proxysql.log&quot;</span></span><br><span class=line></span><br><span class=line><span class=comment># 设置管理变量，包括监听的端口、管理账号等。</span></span><br><span class=line>admin_variables=</span><br><span class=line>&#123;</span><br><span class=line>	admin_credentials=<span class=string>&quot;admin:admin&quot;</span></span><br><span class=line>	mysql_ifaces=<span class=string>&quot;0.0.0.0:6032&quot;</span></span><br><span class=line>	debug=<span class=literal>true</span></span><br><span class=line>    web_enabled=<span class=literal>true</span></span><br><span class=line>&#125;</span><br><span class=line><span class=comment># 设置MySQL 数据库 变量，监听账号、密码等。</span></span><br><span class=line>mysql_variables=</span><br><span class=line>&#123;</span><br><span class=line>	threads=4</span><br><span class=line>	max_connections=2048</span><br><span class=line>	default_query_delay=0</span><br><span class=line>	default_query_timeout=36000000</span><br><span class=line>	have_compress=<span class=literal>true</span></span><br><span class=line>	poll_timeout=2000</span><br><span class=line>	interfaces=<span class=string>&quot;0.0.0.0:6033&quot;</span></span><br><span class=line>	default_schema=<span class=string>&quot;information_schema&quot;</span></span><br><span class=line>	stacksize=1048576</span><br><span class=line>	server_version=<span class=string>&quot;5.5.30&quot;</span></span><br><span class=line>	connect_timeout_server=3000</span><br><span class=line>	monitor_username=<span class=string>&quot;maxmon&quot;</span></span><br><span class=line>	monitor_password=<span class=string>&quot;1234@abCD&quot;</span></span><br><span class=line>	monitor_history=600000</span><br><span class=line>	monitor_connect_interval=60000</span><br><span class=line>	monitor_ping_interval=10000</span><br><span class=line>	monitor_read_only_interval=1500</span><br><span class=line>	monitor_read_only_timeout=500</span><br><span class=line>	ping_interval_server_msec=120000</span><br><span class=line>	ping_timeout_server=500</span><br><span class=line>	commands_stats=<span class=literal>true</span></span><br><span class=line>	sessions_sort=<span class=literal>true</span></span><br><span class=line>	connect_retries_on_failure=10</span><br><span class=line>&#125;</span><br><span class=line></span><br><span class=line><span class=comment># defines all the MySQL servers</span></span><br><span class=line>mysql_servers =</span><br><span class=line>(</span><br><span class=line>	&#123; address=<span class=string>&quot;192.168.56.115&quot;</span> , port=3306 , hostgroup=0 &#125;,</span><br><span class=line>	&#123; address=<span class=string>&quot;192.168.56.113&quot;</span> , port=3306 , hostgroup=1 &#125;,</span><br><span class=line>)</span><br><span class=line></span><br><span class=line><span class=comment># defines all the MySQL users</span></span><br><span class=line>mysql_users:</span><br><span class=line>(</span><br><span class=line>   &#123; username = <span class=string>&quot;ivy_base&quot;</span> , password = <span class=string>&quot;1234@abCD&quot;</span> , default_hostgroup = 0 , active = 1 &#125;</span><br><span class=line>)</span><br><span class=line></span><br><span class=line><span class=comment>#定义查询路由规则</span></span><br><span class=line>mysql_query_rules:</span><br><span class=line>(</span><br><span class=line>	&#123;</span><br><span class=line>		rule_id=1</span><br><span class=line>		active=1</span><br><span class=line>		match_pattern=<span class=string>&quot;^SELECT .* FOR UPDATE$&quot;</span></span><br><span class=line>		destination_hostgroup=0</span><br><span class=line>		apply=1</span><br><span class=line>	&#125;,</span><br><span class=line>	&#123;</span><br><span class=line>		rule_id=2</span><br><span class=line>		active=1</span><br><span class=line>		match_pattern=<span class=string>&quot;^SELECT&quot;</span></span><br><span class=line>		destination_hostgroup=1</span><br><span class=line>		apply=1</span><br><span class=line>	&#125;,</span><br><span class=line>    &#123;</span><br><span class=line>        rule_id=3</span><br><span class=line>        active=1</span><br><span class=line>        match_pattern=<span class=string>&quot;^explain&quot;</span></span><br><span class=line>        destination_hostgroup=0</span><br><span class=line>        apply=1</span><br><span class=line>    &#125;</span><br><span class=line>)</span><br><span class=line><span class=comment>#调度器是一个类似于cron的实现，具有毫秒的粒度。</span></span><br><span class=line>scheduler=</span><br><span class=line>(</span><br><span class=line>)</span><br><span class=line><span class=comment># 定义 hostgroup 的主从关系</span></span><br><span class=line>mysql_replication_hostgroups=</span><br><span class=line>(</span><br><span class=line>)</span><br></pre></td></tr></table></figure></li><li><p>启动proxysql</p></li></ol><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 启动</span></span><br><span class=line>systemctl start proxysql</span><br><span class=line><span class=comment># 加入开机自启动</span></span><br><span class=line>systemctl <span class=built_in>enable</span> proxysql</span><br></pre></td></tr></table></figure><ol start=6><li><p>在ProxySQL 服务器上安装MySQL client</p><p>同MySQL Master 搭建相同，只是不安装server端</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br></pre></td><td class=code><pre><span class=line>yum install mysql-community-&#123;client,common,libs&#125;-* --exclude=<span class=string>&#x27;*minimal*&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>打开防火墙端口<code>6033</code></p></li><li><p>测试</p><p>用MySQL客户端或者命令连接上proxysql，对数据库的表进行添加和查询数据，观察read/write值的变化</p><figure class="highlight sh"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br></pre></td><td class=code><pre><span class=line><span class=comment># 1. 在主或从MySQL数据库服务器上连接proxysql</span></span><br><span class=line>mysql -h 192.168.56.112 -P 6033 -uivy_base -p</span><br><span class=line><span class=comment># 2. 执行创建表、添加数据、查询数据等操作</span></span><br><span class=line>CREATE TABLE `<span class=built_in>test</span>` (</span><br><span class=line>  `id` int(11) NOT NULL,</span><br><span class=line>  `name` varchar(200) DEFAULT NULL,</span><br><span class=line>  PRIMARY KEY (`id`)</span><br><span class=line>) ;</span><br><span class=line>INSERT INTO <span class=built_in>test</span> (id, NAME) VALUES (<span class=string>&#x27;2&#x27;</span>, <span class=string>&#x27;1&#x27;</span>);</span><br><span class=line>select * from <span class=built_in>test</span>;</span><br><span class=line><span class=comment># 3. 在proxysql观察情况</span></span><br><span class=line>mysql -uadmin -p -h 127.0.0.1 -P 6032 --prompt=<span class=string>&#x27;admin&gt;&#x27;</span></span><br><span class=line><span class=comment>#执行语句监控</span></span><br><span class=line>select hostgroup,username,digest_text,count_star from stats_mysql_query_digest;</span><br><span class=line><span class=comment># 结果，通过缓存hostgroup和语句我们发现我们是配置成功的</span></span><br><span class=line>+-----------+-------------------------------------------------------------------------------------------------+------------+</span><br><span class=line>| hostgroup | digest_text                                                                                     | count_star |</span><br><span class=line>+-----------+-------------------------------------------------------------------------------------------------+------------+</span><br><span class=line>| 0         | INSERT INTO <span class=built_in>test</span> (id,NAME) VALUES (?,?)                                                         | 1          |</span><br><span class=line>| 0         | CREATE TABLE `<span class=built_in>test</span>` ( `id` int(?) NOT NULL, `name` varchar(?) DEFAULT NULL, PRIMARY KEY (`id`)) | 1          |</span><br><span class=line>| 1         | select * from <span class=built_in>test</span>                                                                              | 3          |</span><br><span class=line>| 0         | CREATE TABLE `<span class=built_in>test</span>` ( `id` int(?) NOT NULL, `name` varchar(?) DEFAULT NULL, PRIMARY KEY (`id`)) | 1          |</span><br><span class=line>| 1         | SELECT * FROM `douban_book` WHERE ?=?                                                           | 1          |</span><br><span class=line>| 0         | select @@version_comment <span class=built_in>limit</span> ?                                                                | 1          |</span><br><span class=line>| 1         | SELECT DATABASE()                                                                               | 1          |</span><br><span class=line>| 0         | show databases                                                                                  | 1          |</span><br><span class=line>| 0         | show tables                                                                                     | 1          |</span><br><span class=line>+-----------+-------------------------------------------------------------------------------------------------+------------+</span><br><span class=line></span><br><span class=line></span><br></pre></td></tr></table></figure></li></ol><h5 id=ProxySQL-配置说明><a href=#ProxySQL-配置说明 class=headerlink title="ProxySQL 配置说明"></a>ProxySQL 配置说明</h5><p>ProxySQL 配置有两种方式一种是通过<code>/etc/proxysql.cnf</code>配置文件,另一种是通过admin interface方式（即在proxysql本机使用mysql客户端连接管理端口），但第二种方式依赖于第一种方式，因为一些基础的配置必须通过配置文件来配置。</p><p>ProxySQL有配置文件<code>/etc/proxysql.cnf</code>和配置数据库文件<code>/var/lib/proxysql/proxysql.db</code>。</p><p><strong>特别注意：</strong></p><p>ProxySQL服务只有在第一次启动时才会去读取proxysql.cnf文件并解析；后面启动会就不会读取proxysql.cnf文件了！</p><p>如果想要让<code>proxysql.cnf</code>文件里的配置在重启proxysql服务后生效(即想要让proxysql重启时读取并解析proxysql.cnf配置文件)，则需要先删除<code>/var/lib/proxysql/proxysql.db</code>数据库文件，然后再重启proxysql服务。这样就相当于初始化启动proxysql服务了，会再次生产一个纯净的proxysql.db数据库文件(如果通过admin interface方式配置的数据，则就会被抹掉)。</p><p><strong>官方推荐</strong>用admin interface方式！</p><ol><li><p>ProxySQL 库介绍</p><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br></pre></td><td class=code><pre><span class=line>admin<span class=operator>&gt;</span><span class=keyword>show</span> databases;</span><br><span class=line><span class=operator>+</span><span class=comment>-----+---------------+-------------------------------------+</span></span><br><span class=line><span class=operator>|</span> seq <span class=operator>|</span> name          <span class=operator>|</span> file                                <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----+---------------+-------------------------------------+</span></span><br><span class=line><span class=operator>|</span> <span class=number>0</span>   <span class=operator>|</span> main          <span class=operator>|</span>                                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>2</span>   <span class=operator>|</span> disk          <span class=operator>|</span> <span class=operator>/</span>var<span class=operator>/</span>lib<span class=operator>/</span>proxysql<span class=operator>/</span>proxysql.db       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>3</span>   <span class=operator>|</span> stats         <span class=operator>|</span>                                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>4</span>   <span class=operator>|</span> monitor       <span class=operator>|</span>                                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> <span class=number>5</span>   <span class=operator>|</span> stats_history <span class=operator>|</span> <span class=operator>/</span>var<span class=operator>/</span>lib<span class=operator>/</span>proxysql<span class=operator>/</span>proxysql_stats.db <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>-----+---------------+-------------------------------------+</span></span><br></pre></td></tr></table></figure><p>**main:**配置数据库，表里存放后端DB实例、用户验证、路由规则等信息。表名以 runtime_开头的表示proxysql当前运行的配置内容，不能通过dml语句修改，只能修改对应的不以 runtime_ 开头的（在内存）里的表，然后 LOAD 使其生效， SAVE 使其存到硬盘以供下次重启加载。</p><p>**disk:**是持久化到硬盘的配置，sqlite数据文件。默认位置为 $（DATADIR）/proxysql.db</p><p>**stats:**proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询种类汇总/执行时间等等</p><p>**monitor:**存储 monitor 模块收集的信息，主要是对后端db的健康/延迟检查。</p><p>**stats_history:**统计信息历史库</p></li><li><p>main 库</p><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br><span class=line>30</span><br><span class=line>31</span><br><span class=line>32</span><br><span class=line>33</span><br><span class=line>34</span><br><span class=line>35</span><br><span class=line>36</span><br><span class=line>37</span><br></pre></td><td class=code><pre><span class=line>admin<span class=operator>&gt;</span> <span class=keyword>show</span> tables <span class=keyword>from</span> main;</span><br><span class=line><span class=operator>+</span><span class=comment>----------------------------------------------------+</span></span><br><span class=line><span class=operator>|</span> tables                                             <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------------------------------------------------+</span></span><br><span class=line><span class=operator>|</span> global_variables                                   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_aws_aurora_hostgroups                        <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_collations                                   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_firewall_whitelist_rules                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_firewall_whitelist_sqli_fingerprints         <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_firewall_whitelist_users                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_galera_hostgroups                            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_group_replication_hostgroups                 <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_query_rules                                  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_query_rules_fast_routing                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_replication_hostgroups                       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_servers                                      <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_users                                        <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> proxysql_servers                                   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> restapi_routes                                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_checksums_values                           <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_global_variables                           <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_aws_aurora_hostgroups                <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_firewall_whitelist_rules             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_firewall_whitelist_sqli_fingerprints <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_firewall_whitelist_users             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_galera_hostgroups                    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_group_replication_hostgroups         <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_query_rules                          <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_query_rules_fast_routing             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_replication_hostgroups               <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_servers                              <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_mysql_users                                <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_proxysql_servers                           <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_restapi_routes                             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> runtime_scheduler                                  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> scheduler                                          <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>----------------------------------------------------+</span></span><br></pre></td></tr></table></figure><p>常用表介绍：</p><p><strong>global_variables：</strong>用于定义全局变量。这是一个非常简单的表，本质上是一个key/value存储系统。<br><strong>mysql_collations：</strong>相关字符集和校验规则。<br><strong>mysql_query_rules：</strong>定义查询路由规则。<br><strong>mysql_servers：</strong>设置后端MySQL的表<br><strong>mysql_users：</strong>配置后端数据库的程序账号和监控账号。<br><strong>scheduler：</strong>调度器是一个类似于cron的实现，集成在ProxySQL中，具有毫秒的粒度。通过脚本检测来设置ProxySQL。</p><p><strong>mysql_replication_hostgroups：</strong>监视指定主机组中所有服务器的read_only值，并且根据read_only的值将服务器分配给写入器或读取器主机组。ProxySQL monitor模块会监控hostgroups后端所有servers 的read_only 变量，如果发现从库的read_only变为0、主库变为1，则认为角色互换了，自动改写mysql_servers表里面 hostgroup关系，达到自动 Failover 效果。</p><p>*<em>runtime_</em>:**运行时的配置，这些是不能修改的</p></li><li><p>disk 库</p><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br></pre></td><td class=code><pre><span class=line>admin<span class=operator>&gt;</span> <span class=keyword>show</span> tables <span class=keyword>from</span> disk;</span><br><span class=line><span class=operator>+</span><span class=comment>--------------------------------------------+</span></span><br><span class=line><span class=operator>|</span> tables                                     <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------------------------------------------+</span></span><br><span class=line><span class=operator>|</span> global_settings                            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> global_variables                           <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_aws_aurora_hostgroups                <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_collations                           <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_firewall_whitelist_rules             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_firewall_whitelist_sqli_fingerprints <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_firewall_whitelist_users             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_galera_hostgroups                    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_group_replication_hostgroups         <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_query_rules                          <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_query_rules_fast_routing             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_replication_hostgroups               <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_servers                              <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_users                                <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> proxysql_servers                           <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> restapi_routes                             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> scheduler                                  <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------------------------------------------+</span></span><br></pre></td></tr></table></figure><p>用于将配置持久化到磁盘上。配置持久化后，下次重启ProxySQL时就会读取这些已被持久化的配置。这些表完全对应于内存数据库中的表。</p></li><li><p>stats 库</p><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br><span class=line>25</span><br><span class=line>26</span><br><span class=line>27</span><br><span class=line>28</span><br><span class=line>29</span><br></pre></td><td class=code><pre><span class=line>admin<span class=operator>&gt;</span> <span class=keyword>show</span> tables <span class=keyword>from</span> stats;</span><br><span class=line><span class=operator>+</span><span class=comment>---------------------------------------+</span></span><br><span class=line><span class=operator>|</span> tables                                <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------------------------------------+</span></span><br><span class=line><span class=operator>|</span> global_variables                      <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_memory_metrics                  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_client_host_cache         <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_client_host_cache_reset   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_commands_counters         <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_connection_pool           <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_connection_pool_reset     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_errors                    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_errors_reset              <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_free_connections          <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_global                    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_gtid_executed             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_prepared_statements_info  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_processlist               <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_query_digest              <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_query_digest_reset        <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_query_rules               <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_mysql_users                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_proxysql_message_metrics        <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_proxysql_message_metrics_reset  <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_proxysql_servers_checksums      <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_proxysql_servers_clients_status <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_proxysql_servers_metrics        <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> stats_proxysql_servers_status         <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------------------------------------+</span></span><br></pre></td></tr></table></figure><p>常用表：</p><p><strong>stats_mysql_commands_counters：</strong>统计各种SQL类型的执行次数和时间，通过参数mysql-commands_stats控制开关，默认是ture。<br><strong>stats_mysql_connection_pool：</strong>连接后端MySQL的连接信息。<br><strong>stats_mysql_processlist：</strong>类似MySQL的show processlist的命令，查看各线程的状态。<br><strong>stats_mysql_query_digest：</strong>表示SQL的执行次数、时间消耗等。通过变量mysql-query_digests控制开关，默认是开。<br><strong>stats_mysql_query_rules：</strong>路由命中次数统计。</p></li><li><p>monitor 库</p><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br></pre></td><td class=code><pre><span class=line>admin<span class=operator>&gt;</span> <span class=keyword>show</span> tables <span class=keyword>from</span> monitor;</span><br><span class=line><span class=operator>+</span><span class=comment>--------------------------------------+</span></span><br><span class=line><span class=operator>|</span> tables                               <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------------------------------------+</span></span><br><span class=line><span class=operator>|</span> mysql_server_aws_aurora_check_status <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_server_aws_aurora_failovers    <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_server_aws_aurora_log          <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_server_connect_log             <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_server_galera_log              <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_server_group_replication_log   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_server_ping_log                <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_server_read_only_log           <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_server_replication_lag_log     <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>--------------------------------------+</span></span><br></pre></td></tr></table></figure><p>常用表：</p><p><strong>mysql_server_connect_log：</strong>连接到所有MySQL服务器以检查它们是否可用，该表用来存放检测连接的日志。<br><strong>mysql_server_ping_log：</strong>使用mysql_ping API ping后端MySQL服务器，检查它们是否可用，该表用来存放ping的日志。<br><strong>mysql_server_replication_lag_log：</strong>后端MySQL服务主从延迟的检测。</p></li><li><p>stats_history库</p><figure class="highlight sql"><table><tr><td class=gutter><pre><span class=line>1</span><br><span class=line>2</span><br><span class=line>3</span><br><span class=line>4</span><br><span class=line>5</span><br><span class=line>6</span><br><span class=line>7</span><br><span class=line>8</span><br><span class=line>9</span><br><span class=line>10</span><br><span class=line>11</span><br><span class=line>12</span><br><span class=line>13</span><br><span class=line>14</span><br><span class=line>15</span><br><span class=line>16</span><br><span class=line>17</span><br><span class=line>18</span><br><span class=line>19</span><br><span class=line>20</span><br><span class=line>21</span><br><span class=line>22</span><br><span class=line>23</span><br><span class=line>24</span><br></pre></td><td class=code><pre><span class=line>admin<span class=operator>&gt;</span> <span class=keyword>show</span> tables <span class=keyword>from</span> stats_history;</span><br><span class=line><span class=operator>+</span><span class=comment>---------------------------------------+</span></span><br><span class=line><span class=operator>|</span> tables                                <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------------------------------------+</span></span><br><span class=line><span class=operator>|</span> history_mysql_query_digest            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> history_mysql_status_variables        <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> history_mysql_status_variables_lookup <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> history_stats_mysql_connection_pool   <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> myhgm_connections                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> myhgm_connections_day                 <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> myhgm_connections_hour                <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_connections                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_connections_day                 <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_connections_hour                <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_query_cache                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_query_cache_day                 <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> mysql_query_cache_hour                <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> system_cpu                            <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> system_cpu_day                        <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> system_cpu_hour                       <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> system_memory                         <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> system_memory_day                     <span class=operator>|</span></span><br><span class=line><span class=operator>|</span> system_memory_hour                    <span class=operator>|</span></span><br><span class=line><span class=operator>+</span><span class=comment>---------------------------------------+</span></span><br></pre></td></tr></table></figure></li><li><p>配置主要表介绍</p><ul><li><strong>mysql_servers</strong></li></ul><table><thead><tr><th align=left>列</th><th align=left>说明</th></tr></thead><tbody><tr><td align=left>hostgroup_id</td><td align=left>ProxySQL通过 hostgroup (<strong>下称HG</strong>) 的形式组织后端db实例。一个 HG 代表同属于一个角色<br>该表的主键是 (hostgroup_id, hostname, port)，可以看到一个 hostname:port 可以在多个hostgroup里面，这样可以避免 HG 1000 的从库全都不可用时，依然可以把读请求发到主库上。<br>一个 HG 可以有多个实例，即多个从库，可以通过 weight 分配权重<br>hostgroup_id 0 是一个特殊的HG，路由查询的时候，没有匹配到规则则默认选择 HG 0</td></tr><tr><td align=left>hostname</td><td align=left>后端MySQL监听的地址</td></tr><tr><td align=left>port</td><td align=left>后端MySQL监听的端口</td></tr><tr><td align=left>gtid_port</td><td align=left>ProxySQL Binlog Reader为追踪GTID而监听的后端服务器端口。</td></tr><tr><td align=left>status</td><td align=left>ONLINE: 当前后端实例状态正常<br>SHUNNED: 临时被剔除，可能因为后端 too many connections error，或者超过了可容忍延迟阀值 max_replication_lag<br>OFFLINE_SOFT: “软离线”状态，不再接受新的连接，但已建立的连接会等待活跃事务完成。<br>OFFLINE_HARD: “硬离线”状态，不再接受新的连接，已建立的连接或被强制中断。当后端实例宕机或网络不可达，会出现。</td></tr><tr><td align=left>weight</td><td align=left>节点在组中的权重值越高，ProxySQL会发送越多请求给它们。</td></tr><tr><td align=left>compression</td><td align=left>如果该字段的值设置为大于0，ProxySQL和该后端新建的连接中，ProxySQL将会先压缩数据再传输。</td></tr><tr><td align=left>max_connections</td><td align=left>允许连接到该后端mysql实例的最大连接数。不要大于MySQL设置的 max_connections，如果后端实例 hostname:port 在多个 hostgroup 里，以较大者为准，而不是各自独立允许的最大连接数。</td></tr><tr><td align=left>max_replication_lag</td><td align=left>允许的最大延迟，主库不受这个影响，默认0。如果 &gt; 0， monitor 模块监控主从延迟大于阀值时，会临时把它变为 SHUNNED</td></tr><tr><td align=left>use_ssl</td><td align=left>如果设置为1，则和该后端MySQL建立SSL连接。</td></tr><tr><td align=left>max_latency_ms</td><td align=left>mysql_ping 响应时间，大于这个阀值会把它从连接池剔除（即使是ONLINE）</td></tr><tr><td align=left>comment</td><td align=left>备注，不建议留空。可以通过它的内容如json格式的数据，配合自己写的check脚本，完成一些自动化的工作。</td></tr></tbody></table><ul><li><p><strong>mysql_query_rules</strong></p><p>ProxySQL非常核心一个表，定义查询路由规则</p></li></ul><table><thead><tr><th align=left>列</th><th>说明</th></tr></thead><tbody><tr><td align=left>rule_id</td><td>表主键，自增。规则处理是以 rule_id 的顺序进行。</td></tr><tr><td align=left>active</td><td>只有 active=1 的规则才会参与匹配。</td></tr><tr><td align=left>username</td><td>如果非 NULL，只有连接用户是 username 的值才会匹配。</td></tr><tr><td align=left>schemaname</td><td>如果非 NULL，只有查询连接使用的db是 schemaname 的值才会匹配。注意如果是 NULL，不代表连接没有使用schema，而是不伦任何schema都进一步匹配。</td></tr><tr><td align=left>flagIN</td><td>flagIN, flagOUT, apply: 用来定义路由链 chains of rules。<br><strong>-</strong> 首先会检查 flagIN=0 的规则，以rule_id的顺序；如果都没匹配上，则走这个用户的 default_hostgroup。<br><strong>-</strong> 当匹配一条规则后，会检查 flagOUT。<br><strong>-</strong> 如果不为NULL，并且 flagIN != flagOUT ，则进入以flagIN为上一个flagOUT值的新规则链。<br><strong>-</strong> 如果不为NULL，并且 flagIN = flagOUT，则应用这条规则。<br><strong>-</strong> 如果为NULL，或者 apply=1，则结束，应用这条规则。<br><strong>-</strong> 如果最终没有匹配到，则找到这个用户的 default_hostgroup。</td></tr><tr><td align=left>client_addr</td><td>匹配客户端来源IP</td></tr><tr><td align=left>proxy_addr</td><td>当流入的查询是在本地某地址上时，将匹配。</td></tr><tr><td align=left>proxy_port</td><td>当流入的查询是在本地某端口上时，将匹配。</td></tr><tr><td align=left>digest</td><td>精确的匹配一类查询。</td></tr><tr><td align=left>match_digest</td><td>正则匹配一类查询。query digest 是指对查询去掉具体值后进行“模糊化”后的查询，类似 pt-fingerprint / pt-query-digest 的效果。</td></tr><tr><td align=left>match_pattern</td><td>正则匹配查询。推荐用 match_digest 。关于每条查询都会计算digest对性能的影响，计算query digest确实会有性能损失，但是这却是proxysql里面非常重要的特性，主要是两点：<br><strong>-</strong> proxysql无法知道连接复用(multipexing)是否必须被自动禁用，比如连接里面有variables/tmp tables/lock table等特殊命令，是不能复用的。<br><strong>-</strong> 完整的查询去匹配正则的效率，一般没有参数化后的查询匹配效率高，因为有很长的字符串内容需要处理。再者，SELECT * FROM randomtable WHERE comment LIKE ‘%INTO sbtest1 % FROM sbtest2 %’字符串里有类似这样的语句，很难排除误匹配。</td></tr><tr><td align=left>negate_match_pattern</td><td>反向匹配，相当于对 match_digest/match_pattern 的匹配取反。</td></tr><tr><td align=left>re_modifiers</td><td>修改正则匹配的参数，比如默认的：忽略大小写CASELESS、禁用GLOBAL.</td></tr><tr><td align=left>flagOUT</td><td><strong>上面都是匹配规则，下面是匹配后的行为</strong></td></tr><tr><td align=left>replace_pattern</td><td>查询重写，默认为空，不rewrite。</td></tr><tr><td align=left>destination_hostgroup</td><td>路由查询到这个 hostgroup。当然如果用户显式 start transaction 且 transaction_persistent=1，那么即使匹配到了，也依然按照事务里第一条sql的路由规则去走。</td></tr><tr><td align=left>cache_ttl</td><td>查询结果缓存的毫秒数。</td></tr><tr><td align=left>cache_empty_result</td><td>控制结果集为空是否会被缓存。</td></tr><tr><td align=left>cache_timeout</td><td>没有实现</td></tr><tr><td align=left>reconnect</td><td>未使用的功能</td></tr><tr><td align=left>timeout</td><td>这一类查询执行的最大时间（毫秒），超时则自动kill。<br>这是对后端DB的保护机制，相当于阿里云RDS loose_max_statement_time 变量的功能，但是注意不同的是，阿里云这个变量的时间时不包括DML操作出现InnoDB行锁等待的时间，而ProxySQL的这个 timeout 是计算从发送sql到等待响应的时间。默认mysql-default_query_timeout给的是 10h .</td></tr><tr><td align=left>retries</td><td>语句在执行时失败时，重试次数。默认由 mysql-query_retries_on_failure变量指定，为1 。<br>个人建议把它设成0，即不重试。因为执行失败，对select而言很少见，主要是dml，但自己重试对数据不放心。</td></tr><tr><td align=left>delay</td><td>查询延迟执行，这是ProxySQL提供的限流机制，会让其它的查询优先执行。<br>默认值 mysql-default_query_delay，为0。我们一般不用，其实还是要配合应用端使用，比如这边延迟执行，但上层等待你返回，那前端不就堵住了，没准出现雪崩效应。</td></tr><tr><td align=left>next_query_flagIN</td><td></td></tr><tr><td align=left>mirror_flagOUT</td><td></td></tr><tr><td align=left>mirror_hostgroup</td><td></td></tr><tr><td align=left>error_msg</td><td>默认为NULL，如果指定了则这个查询直接被 block 掉，马上返回这个错误信息。<br>这个功能也很实用，比如线上突然冒出一个 “坏查询”，应用端不方便马上发版解决，我们就可以在这配置一个规则，把查询屏蔽掉，想正常的mysql报错那样抛异常。</td></tr><tr><td align=left>OK_msg</td><td>对于使用定义的规则的查询，将返回指定的信息。</td></tr><tr><td align=left>sticky_conn</td><td>没实现</td></tr><tr><td align=left>multiplex</td><td>连接是否复用。</td></tr><tr><td align=left>gtid_from_hostgroup</td><td>定义哪个主机组应该被用作GTID一致读取的领导者（通常是复制主机组对中定义的WRITER主机组）。</td></tr><tr><td align=left>log</td><td>是否记录查询日志。可以看到log是否记录的对象是根据规则。<br>要开启日志记录，需要设置变量 mysql-eventslog_filename 来指定文件名，然后这个 log 标记为1。但是目前proxysql记录的日志是二进制格式，需要特定的工具才能读取： eventslog_reader_sample 。这个工具在源码目录 tools下面。</td></tr><tr><td align=left>apply</td><td>当设置为1后，当匹配到该规则后，将立即应用该规则，不会再评估其它的规则(注意：应用之后，将不会评估<code>mysql_query_rules_fast_routing</code>中的规则)。</td></tr><tr><td align=left>attributes</td><td>没实现</td></tr><tr><td align=left>comment</td><td>注释说明字段，例如描述规则的意义</td></tr></tbody></table><ul><li><strong>mysql_users</strong></li></ul><table><thead><tr><th>列</th><th>说明</th></tr></thead><tbody><tr><td>username</td><td>连接后端db的用户密码。</td></tr><tr><td>password</td><td>这个密码你可以插入明文，也可以插入hash加密后的密文，proxysql会检查你插入的时候密码是否以 * 开头来判断，而且密文要在其它地方使用 PASSWORD()生成。但到 runtime_mysql_users 里，都统一变成了密文，所以可以明文插入，再 SAVE MYSQL USERS TO MEM，此时看到的也是HASH密文。</td></tr><tr><td>active</td><td>是否生效该用户。默认1</td></tr><tr><td>use_ssl</td><td>是否开启ssl 默认1</td></tr><tr><td>default_hostgroup</td><td>这个用户的请求没有匹配到规则时，默认发到这个 hostgroup，默认0</td></tr><tr><td>default_schema</td><td>这个用户连接时没有指定 database name 时，默认使用的schema<br>注意表面上看默认为NULL，但实际上受到变量 mysql-default_schema 的影响，默认为 information_schema。</td></tr><tr><td>schema_locked</td><td>还不支持</td></tr><tr><td>transaction_persistent</td><td>如果设置为1，连接上ProxySQL的会话后，如果在一个hostgroup上开启了事务，那么后续的sql都继续维持在这个hostgroup上，不伦是否会匹配上其它路由规则，直到事务结束。默认1</td></tr><tr><td>fast_forward</td><td>忽略查询重写/缓存层，直接把这个用户的请求透传到后端DB。相当于只用它的连接池功能，一般不用，路由规则 .* 就行了。</td></tr><tr><td>backend</td><td>目前版本这两个都需要使用默认的1，将来有可能会把 Client -&gt; ProxySQL (frontend) 与 ProxySQL -&gt; BackendDB (backend)的认证分开。从 runtime_mysql_users 表内容看到，记录数比 mysql_users 多了一倍，就是把前端认证与后端认证独立出来的结果</td></tr><tr><td>frontend</td><td></td></tr><tr><td>max_connections</td><td>定义了一个特定用户的最大允许的前端连接数。</td></tr><tr><td>attributes</td><td>没实现</td></tr><tr><td>comment</td><td>文本字段，可用于用户定义的任何目的。可以是对集群存储内容的描述，也可以是对主机组添加或禁用时间的提醒，或者是一些检查器脚本所处理的JSON。</td></tr></tbody></table><ul><li><strong>mysql_replication_hostgroups</strong></li></ul><table><thead><tr><th>列</th><th>说明</th></tr></thead><tbody><tr><td>writer_hostgroup</td><td>默认的写组。后端<code>read_only=0</code>的节点会分配到这个组中。</td></tr><tr><td>reader_hostgroup</td><td>负责读的组。查询规则或者只具有只读权限的用户的读请求都会路由到该主机组中的节点。后端<code>read_only=1</code>的节点会分配到这个组中。</td></tr><tr><td>check_type</td><td>默认read_only</td></tr><tr><td>comment</td><td>该字段用于说明、注释。</td></tr></tbody></table></li></ol><h4 id=结语><a href=#结语 class=headerlink title=结语></a>结语</h4><p>只支持读写分离，MySQL 主节点出问题，还是会有问题，后续可以把MySQL搭建为双主</p><h4 id=参考资料><a href=#参考资料 class=headerlink title=参考资料></a>参考资料</h4><ol><li><a target=_blank rel=noopener href=https://unix.stackexchange.com/questions/102558/mysql-permission-denied-error-even-after-setting-security-context-for-selinux-on>MySQL permission denied error even after setting security context for SELinux on VM</a></li><li><a target=_blank rel=noopener href=https://gist.github.com/linuxkathirvel/96b6f6be705d5e569c0c7425cea70273>MySQL 5.7 installation in CentOS 7</a></li><li><a target=_blank rel=noopener href=https://www.cnblogs.com/kevingrace/p/10329714.html>ProxySQL 配置详解及读写分离(+GTID)等功能说明 (完整篇)</a></li><li><a target=_blank rel=noopener href=https://github.com/malongshuai/proxysql/wiki>中文文档</a></li></ol></div><footer class=post-footer><div class=post-tags><a href=/tags/HA/ rel=tag># HA</a> <a href=/tags/High-Availability/ rel=tag># High Availability</a> <a href=/tags/MySQL/ rel=tag># MySQL</a></div><div class=post-nav><div class=post-nav-item><a href=/2023/02/21/es/es_learning/ rel=prev title="Elasticsearch learning"><i class="fa fa-chevron-left"></i> Elasticsearch learning</a></div><div class=post-nav-item><a href=/2023/03/15/mysql/mariadb-ha/ rel=next title=搭建MariaDB读写分离、高可用>搭建MariaDB读写分离、高可用 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy; <span itemprop=copyrightYear>2024</span> <span class=with-love><i class="fa fa-user"></i> </span><span class=author itemprop=copyrightHolder>tungSing</span></div></div></footer><script src=https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=/js/comments.js></script><script src=/js/utils.js></script><script src=/js/motion.js></script><script src=/js/next-boot.js></script><script src=/js/pjax.js></script><script src=https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin=anonymous></script><script src=/js/third-party/search/local-search.js></script><script src=/js/third-party/fancybox.js></script><script src=/js/third-party/photo/lazyload.js></script><script src=/js/third-party/photo/minigrid.min.js></script><script data-pjax src=/js/third-party/photo/photo.js></script></body></html>